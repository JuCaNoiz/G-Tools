<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G-Tools</title>
    <!-- Incluye Tailwind CSS para estilos rápidos y responsivos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fuente Inter para un look moderno -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Estilos generales del cuerpo */
        body {
            font-family: 'Courier', sans-serif;
            background-color: #00050d; /* Fondo oscuro */
            color: #fffffc; /* Texto claro */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        /* Contenedor principal para organizar el layout */
        .main-container {
            display: flex;
            flex-wrap: wrap; /* Permite que los elementos se envuelvan en pantallas pequeñas */
            gap: 20px; /* Espacio entre las secciones */
            justify-content: center;
            width: 100%;
            max-width: 1200px; /* Ancho máximo para el contenido */
        }
        /* Estilos para los círculos de las notas en SVG (círculo exterior) */
        .note-circle {
            transition: fill 0.2s ease-in-out;
            cursor: pointer;
            fill: #63728a; /* Color de fondo por defecto de la nota mayor (más claro) */
            stroke: #a0aec0; /* Borde de la nota */
            stroke-width: 2;
            border-radius: 9999px;
        }
        /* Estilos para el texto de las notas mayores */
        .note-text {
            fill: #f1f2f0; /* Color de texto más claro */
            pointer-events: none;
            font-size: 1.25rem;
            font-weight: 600;
            user-select: none;
        }
        /* Efecto al pasar el mouse sobre el grupo de la nota mayor */
        .note-group.major:hover .note-circle {
            fill: #63b3ed; /* Azul claro al pasar el mouse */
        }
        /* Estilos para los círculos de las notas del círculo interno (menores) */
        .minor-note-circle {
            transition: fill 0.2s ease-in-out;
            cursor: pointer;
            fill: #4a5568; /* Un gris más oscuro para el fondo de la nota menor (más claro) */
            stroke: #a0aec0;
            stroke-width: 2;
            border-radius: 9999px;
        }
        /* Estilos para el texto de las notas menores */
        .minor-note-text {
            fill: #e2e8f0;
            pointer-events: none;
            font-size: 1rem;
            font-weight: 600;
            user-select: none;
        }
        /* Efecto al pasar el mouse sobre el grupo de la nota menor */
        .note-group.minor:hover .minor-note-circle {
            fill: #9f7aea; /* Morado claro al pasar el mouse */
        }

        /* NUEVOS ESTILOS PARA LOS COLORES DE RESALTADO */
        /* Tónica Mayor Seleccionada */
        .note-group.highlighted-tonic-major .note-circle {
            fill: #f6ad55; /* Naranja */
            stroke: #ed8936;
        }
        .note-group.highlighted-tonic-major .note-text {
            fill: #1a202c;
        }

        /* Otros Acordes Mayores Diatónicos (IV, V) */
        .note-group.highlighted-other-major-diatonic .note-circle {
            fill: #63b3ed; /* Azul claro */
            stroke: #4299e1;
        }
        .note-group.highlighted-other-major-diatonic .note-text {
            fill: #1a202c;
        }

        /* Acordes Menores Diatónicos (ii, iii, vi) - Ahora incluye el vi */
        .note-group.highlighted-other-minor-diatonic .minor-note-circle {
            fill: #48bb78; /* Verde */
            stroke: #38a169;
        }
        .note-group.highlighted-other-minor-diatonic .minor-note-text {
            fill: #1a202c;
        }

        /* Acorde Disminuido Diatónico (vii°) */
        .note-group.highlighted-diminished-diatonic .minor-note-circle {
            fill: #f7079f; /* Magenta vibrante */
            stroke: #b81fb3;
        }
        .note-group.highlighted-diminished-diatonic .minor-note-text {
            fill: #1a202c;
        }


        /* Estilo para el círculo central del SVG */
        .center-circle {
            fill: #2d3748; /* Gris más oscuro para el centro */
            stroke: #a0aec0; /* Borde del círculo central */
            stroke-width: 2;
        }
        /* Estilo para las líneas que conectan las notas del círculo exterior */
        .line {
            stroke: #10bd04; /* Color verde para las líneas */
            stroke-width: 1;
            opacity: 0.5; /* Ligeramente transparentes */
        }
        /* Estilo para las líneas que conectan mayor y menor relativa */
        .relative-line {
            stroke: #63b3ed; /* Azul para conectar mayor y menor */
            stroke-width: 1.5;
            opacity: 0.7;
        }

        /* Estilos para el diapasón */
        #fretboard-svg {
            background-color: #5a3e2b; /* Color madera del diapasón */
            border-radius: 8px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }
        /* Estilos para la sección de composición */
        .composition-section {
            background-color: #2d3748; /* Fondo más oscuro para la sección de composición */
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
            width: 100%;
        }
        /* Estilos para el pentagrama simplificado */
        /* REMOVED: .staff-line, .treble-clef, .staff-note-text, .staff-chord-text */
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #f6ad55;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Estilos para la tablatura */
        .tablature-text {
            fill: #e2e8f0;
            font-family: 'monospace'; /* Fuente monoespaciada para alineación */
            font-size: 14px;
        }
        /* Estilos para los diagramas de acordes */
        .chord-diagram-svg {
            border: 1px solid #a0aec0;
            border-radius: 4px;
            background-color: #2d3748;
            margin-right: 10px;
            margin-bottom: 10px;
            cursor: pointer; /* Make it clickable */
        }
        .fret-line {
            stroke: #e2e8f0;
            stroke-width: 1;
        }
        .string-line {
            stroke: #a0aec0;
            stroke-width: 1.5;
        }
        .nut-line {
            stroke: #e2e8f0;
            stroke-width: 3;
        }
        .finger-dot {
            fill: #f6ad55;
            stroke: #ed8936;
            stroke-width: 1;
        }
        .open-string-marker {
            fill: none;
            stroke: #e2e8f0;
            stroke-width: 1.5;
        }
        .muted-string-marker {
            fill: #e2e8f0;
            font-size: 16px;
            font-weight: bold;
        }
        /* Estilos para el patrón de rasgueo */
        .strum-pattern-svg {
            background-color: #2d3748;
            border-radius: 4px;
            padding: 10px;
        }
        .strum-arrow {
            fill: #e2e8f0;
        }
        .strum-beat-text {
            fill: #a0aec0;
            font-size: 14px;
        }
        .strum-rest-symbol {
            fill: #e2e8f0;
            font-size: 18px;
            font-weight: bold;
        }

        /* Estilos para el afinador */
        .tuner-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .tuner-content {
            background-color: #2d3748;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 600px;
            position: relative;
            text-align: center;
        }
        .tuner-close-button {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            color: #e2e8f0;
            cursor: pointer;
        }
        .tuner-note-display {
            font-size: 4rem;
            font-weight: bold;
            color: #f6ad55;
            margin-bottom: 10px;
        }
        .tuner-cents-display {
            font-size: 1.5rem;
            color: #a0aec0;
            margin-bottom: 20px;
        }
        .tuner-needle-container {
            width: 80%;
            max-width: 300px;
            height: 50px;
            background-color: #1a202c;
            border-radius: 25px;
            margin: 20px auto;
            position: relative;
            overflow: hidden;
        }
        .tuner-needle {
            position: absolute;
            top: 0;
            left: 50%;
            transform-origin: bottom center;
            width: 4px;
            height: 40px;
            background-color: #f6ad55;
            transition: transform 0.1s linear;
        }
        .tuner-center-line {
            position: absolute;
            top: 0;
            left: 50%;
            width: 2px;
            height: 100%;
            background-color: #63b3ed;
        }
        .tuner-range-indicator {
            position: absolute;
            top: 0;
            height: 100%;
            background-color: rgba(99, 179, 237, 0.3); /* blue-300 with transparency */
            border-radius: 25px;
        }
        .tuner-range-indicator.flat {
            left: 0;
        }
        .tuner-range-indicator.sharp {
            right: 0;
        }
        .tuner-controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        .tuner-controls select, .tuner-controls button, .tuner-controls input[type="range"] {
            padding: 10px 15px;
            border-radius: 8px;
            background-color: #4a5568;
            color: #e2e8f0;
            border: 1px solid #63b3ed;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .tuner-controls select:focus, .tuner-controls button:focus, .tuner-controls input[type="range"]:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(99, 179, 237, 0.5);
        }
        .tuner-controls button:hover {
            background-color: #63b3ed;
        }

        /* Metronome styles */
        .metronome-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .metronome-content {
            background-color: #2d3748;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 600px;
            position: relative;
            text-align: center;
        }
        .metronome-close-button {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            color: #e2e8f0;
            cursor: pointer;
        }
        .metronome-display {
            font-size: 3rem;
            font-weight: bold;
            color: #f6ad55;
            margin-bottom: 20px;
        }
        .metronome-controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        .metronome-controls input[type="range"] {
            width: 80%;
            max-width: 300px;
            -webkit-appearance: none;
            height: 10px;
            background: #4a5568;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }
        .metronome-controls input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #63b3ed;
            cursor: pointer;
        }
        .metronome-controls input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #63b3ed;
            cursor: pointer;
        }
        .metronome-beat-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #4a5568;
            display: inline-block;
            margin: 0 5px;
            transition: background-color 0.1s;
        }
        .metronome-beat-indicator.active {
            background-color: #f6ad55;
        }
        .metronome-beat-indicator.first-beat {
            background-color: #63b3ed;
        }
        /* Estilos para la tabla de acordes diatónicos */
        .diatonic-chords-section {
            background-color: #2d3748;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
            width: 100%;
        }
        .diatonic-chords-table {
            width: 100%;
            text-align: center;
            border-collapse: collapse;
        }
        .diatonic-chords-table th, .diatonic-chords-table td {
            border: 1px solid #4a5568;
            padding: 8px;
        }
        .diatonic-chords-table th {
            background-color: #4a5568;
            font-weight: 600;
            color: #e2e8f0;
        }
        .diatonic-chords-table td {
            background-color: #2d3748;
            color: #e2e8f0;
        }
        .diatonic-chords-table .chord-name {
            font-weight: bold;
            color: #f6ad55; /* Naranja para los nombres de acordes */
        }

        /* Estilos para las armaduras de clave en el círculo */
        .key-signature-group {
            pointer-events: none; /* No debe ser clicable */
            user-select: none;
        }
        .mini-staff-line {
            stroke: #a0aec0;
            stroke-width: 0.5;
        }
        .mini-clef {
            fill: #a0aec0;
        }
        .key-symbol {
            fill: #a0aec0;
            font-size: 10px; /* Tamaño pequeño para los símbolos */
            font-family: 'Arial', sans-serif; /* Fuente genérica para los símbolos */
            font-weight: bold;
        }

        /* Fretboard legend styles */
        .fretboard-legend {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            padding: 10px;
            background-color: #2d3748;
            border-radius: 8px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .legend-color-box {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid #a0aec0;
        }
        /* New styles for the Circle of Fifths legend */
        .circle-legend {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            padding: 10px;
            background-color: #2d3748;
            border-radius: 8px;
            width: 100%;
            max-width: 600px;
        }

        /* Chord Options Modal */
        .chord-options-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .chord-options-content {
            background-color: #2d3748;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 800px;
            position: relative;
            text-align: center;
        }
        .chord-options-close-button {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            color: #e2e8f0;
            cursor: pointer;
        }
        .chord-options-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            
            /* Footer styles */
        .app-footer {
            margin-top: 40px;
            padding: 20px;
            text-align: center;
            font-size: 0.9rem;
            color: #666666; /* Gris para el texto del footer */
            width: 100%;
            background-color: #0A0A0A; /* Fondo del footer */
            border-top: 1px solid #222222; /* Línea separadora sutil */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 flex flex-col items-center justify-center min-h-screen p-4">
    <div class="max-w-6xl w-full bg-gray-800 rounded-lg shadow-xl p-6 md:p-8">
        <h1 class="text-3xl md:text-4xl font-bold text-center text-orange-400 mb-6">G-Tolls</h1>
        <p class="text-center text-lg mb-8">
            Dale clic a cualquier nota en el círculo (mayor o menor) para ver los acordes diatónicos de esa tonalidad

        </p>

        <!-- Botones para abrir el afinador y el metrónomo -->
        <div class="flex justify-center gap-4 mb-8">
            <button id="open-tuner-button" class="px-6 py-3 bg-blue-600 text-white font-bold rounded-lg shadow-lg hover:bg-blue-700 transition duration-300 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                    <path fill-rule="evenodd" d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.007 5.404.433c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96-1.425L12 18.354 7.373 21.18c-.996.608-2.231-.292-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.433 2.082-5.007Z" clip-rule="evenodd" />
                </svg>
                Afinador
            </button>
            <button id="open-metronome-button" class="px-6 py-3 bg-indigo-600 text-white font-bold rounded-lg shadow-lg hover:bg-indigo-700 transition duration-300 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                    <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25ZM12.75 6a.75.75 0 0 0-1.5 0v6c0 .414.336.75.75.75h4.5a.75.75 0 0 0 0-1.5h-3.75V6Z" clip-rule="evenodd" />
                </svg>
                Metrónomo
            </button>
        </div>

        <!-- Contenedores principales para el layout flexible -->
        <div class="main-container">
            <!-- Columna Izquierda: Círculo de Quintas -->
            <div class="flex flex-col items-center w-full md:w-3/5 lg:w-1/2 p-4 bg-gray-700 rounded-lg shadow-md">
                <div id="circle-container" class="flex justify-center items-center w-full aspect-square mx-auto mb-8">
                    <!-- El SVG del círculo de quintas se insertará aquí con JavaScript -->
                </div>

                <!-- Leyenda del Círculo de Quintas -->
                <div class="circle-legend">
                    <div class="legend-item">
                        <div class="legend-color-box" style="background-color: #f6ad55;"></div>
                        <span>Tónica Mayor Seleccionada (I)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color-box" style="background-color: #63b3ed;"></div>
                        <span>Acordes Mayores Diatónicos (IV, V)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color-box" style="background-color: #48bb78;"></div>
                        <span>Acordes Menores Diatónicos (ii, iii, vi)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color-box" style="background-color: #f7079f;"></div>
                        <span>Acorde Disminuido Diatónico (vii°)</span>
                    </div>
                </div>

                <!-- Botón de Reiniciar -->
                <div class="mt-4 flex justify-center w-full">
                    <button id="reset-button" class="px-6 py-3 bg-red-600 text-white font-bold rounded-lg shadow-lg hover:bg-red-700 transition duration-300">
                        Reiniciar Selección
                    </button>
                </div>
            </div>

            <!-- Columna Derecha: Explicación de Teoría Musical -->
            <div class="flex flex-col w-full md:w-2/5 lg:w-1/2 p-4 bg-gray-700 rounded-lg shadow-md">
                <div id="info-display" class="bg-gray-700 p-4 rounded-lg shadow-inner text-center mb-4">
                    <h2 class="text-2xl font-semibold text-blue-300 mb-2" id="selected-key-title">Selecciona una tonalidad...</h2>
                    <p class="text-xl" id="scale-notes-display">Las notas diatónicas aparecerán aquí.</p>
                </div>

                <div id="theory-explanation" class="bg-gray-700 p-4 rounded-lg shadow-inner text-left">
                    <h3 class="text-xl font-semibold text-orange-300 mb-2">Teoría Musical de la Selección:</h3>
                    <p id="current-theory-text" class="text-base">
                        Aquí aparecerá una explicación breve sobre la tonalidad mayor o menor que selecciones en el círculo.
                    </p>
                </div>
            </div>
        </div>

        <!-- Nueva sección para la tabla de acordes diatónicos -->
        <div class="diatonic-chords-section w-full max-w-4xl mx-auto mt-8 rounded-lg shadow-lg">
            <h2 class="text-2xl font-bold text-center text-orange-400 mb-4">Acordes Diatónicos en <span id="diatonic-chords-key-display">--</span></h2>
            <table class="diatonic-chords-table">
                <thead>
                    <tr>
                        <th>I</th>
                        <th>ii</th>
                        <th>iii</th>
                        <th>IV</th>
                        <th>V</th>
                        <th>vi</th>
                        <th>vii°</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Tónica</td>
                        <td>Supertónica</td>
                        <td>Mediante</td>
                        <td>Subdominante</td>
                        <td>Dominante</td>
                        <td>Superdominante</td>
                        <td>Sensible</td>
                    </tr>
                    <tr id="diatonic-chords-row">
                        <!-- Los acordes se insertarán aquí con JavaScript -->
                    </tr>
                </tbody>
            </table>
            <p class="text-sm text-gray-400 mt-2 text-center">
                Estos son los acordes diatónicos estándar para la tonalidad seleccionada.
            </p>
        </div>

        <!-- New section for Modes and Fretboard -->
        <div class="modes-fretboard-section w-full max-w-4xl mx-auto mt-8 bg-gray-700 rounded-lg p-4 shadow-lg">
            <h2 class="text-3xl font-bold text-center text-orange-400 mb-6">¡Explora los Modos Griegos!</h2>

            <div class="flex flex-col items-center w-full mb-6">
                <label for="mode-select" class="text-xl font-semibold mb-2 text-blue-300">Elige tu modo griego:</label>
                <select id="mode-select" class="p-2 rounded-md bg-gray-700 text-gray-100 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full max-w-xs">
                    <!-- Las opciones se llenarán con JavaScript -->
                </select>
            </div>

            <!-- Nueva lista desplegable para las posiciones de la escala -->
            <div class="flex flex-col items-center w-full mb-6">
                <label for="fretboard-position-select" class="text-xl font-semibold mb-2 text-blue-300">Posición de la Escala:</label>
                <select id="fretboard-position-select" class="p-2 rounded-md bg-gray-700 text-gray-100 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full max-w-xs">
                    <option value="Full Fretboard">Diapasón Completo</option>
                    <option value="Position 1">Posición 1</option>
                    <option value="Position 2">Posición 2</option>
                    <option value="Position 3">Posición 3</option>
                    <option value="Position 4">Posición 4</option>
                    <option value="Position 5">Posición 5</option>
                </select>
            </div>

            <div id="mode-details-display" class="bg-gray-800 p-4 rounded-lg shadow-inner text-center mb-6">
                <h3 class="text-xl font-semibold text-blue-300 mb-2" id="selected-mode-title">Modo: --</h3>
                <p class="text-base" id="mode-formula-display">Fórmula: --</p>
                <!-- Cambiado a una lista para las notas de la escala -->
                <ul class="text-base text-left mx-auto max-w-md" id="mode-notes-list">
                    <li>Notas de la escala: --</li>
                </ul>
            </div>

            <h2 class="text-2xl font-semibold text-blue-300 mb-4 text-center">Diapasón de Guitarra</h2>
            <svg id="fretboard-svg" class="w-full h-auto" viewBox="0 0 800 250"></svg>

            <!-- Leyenda de colores del diapasón -->
            <div class="fretboard-legend">
                <div class="legend-item">
                    <div class="legend-color-box" style="background-color: #f6ad55;"></div>
                    <span>Notas Fundamentales (Tónica)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color-box" style="background-color: #63b3ed;"></div>
                    <span>Notas de Resolución (Dominante, Sensible)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color-box" style="background-color: #48bb78;"></div>
                    <span>Notas de Descanso (Mediante, Submediante)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color-box" style="background-color: #9f7aea;"></div>
                    <span>Otras Notas de la Escala</span>
                </div>
            </div>
        </div>

        <!-- Sección de Composición de Rola -->
        <div class="composition-section w-full max-w-4xl mx-auto mt-8">
            <h2 class="text-3xl font-bold text-center text-orange-400 mb-6">¡Genera tu Idea de Rola!</h2>

            <div class="flex flex-wrap justify-center gap-4 mb-6">
                <div class="flex flex-col items-center">
                    <label for="feeling-select" class="text-lg font-semibold mb-2 text-blue-300">Sentimiento:</label>
                    <select id="feeling-select" class="p-2 rounded-md bg-gray-700 text-gray-100 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="feliz">Feliz</option>
                        <option value="triste">Triste</option>
                        <option value="energico">Enérgico</option>
                        <option value="relajado">Relajado</option>
                        <option value="misterioso">Misterioso</option>
                    </select>
                </div>
                <div class="flex flex-col items-center">
                    <label for="style-select" class="text-lg font-semibold mb-2 text-blue-300">Estilo:</label>
                    <select id="style-select" class="p-2 rounded-md bg-gray-700 text-gray-100 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="rock">Rock</option>
                        <option value="pop">Pop</option>
                        <option value="blues">Blues</option>
                        <option value="jazz">Jazz</option>
                        <option value="folk">Folk</option>
                        <option value="metal">Metal</option>
                        <option value="electronica">Electrónica</option>
                    </select>
                </div>
                <div class="flex flex-col items-center">
                    <label for="complexity-select" class="text-lg font-semibold mb-2 text-blue-300">Complejidad:</label>
                    <select id="complexity-select" class="p-2 rounded-md bg-gray-700 text-gray-100 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="facil">Fácil</option>
                        <option value="intermedio">Intermedio</option>
                        <option value="avanzado">Avanzado</option>
                    </select>
                </div>
                <!-- Selector para el número de modos -->
                <div class="flex flex-col items-center">
                    <label for="num-modes-select" class="text-lg font-semibold mb-2 text-blue-300">Número de Modos:</label>
                    <select id="num-modes-select" class="p-2 rounded-md bg-gray-700 text-gray-100 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                    </select>
                </div>
            </div>

            <button id="generate-song-idea-button" class="px-8 py-4 bg-green-600 text-white font-bold rounded-lg shadow-lg hover:bg-green-700 transition duration-300 w-full mb-6">
                Generar Idea de Rola
            </button>

            <div id="loading-spinner" class="loading-spinner hidden"></div>

            <div id="song-idea-output" class="bg-gray-800 p-6 rounded-lg shadow-inner hidden">
                <!-- Aquí se mostrará la idea de rola generada -->
                <h3 class="text-2xl font-bold text-orange-300 mb-4" id="song-idea-title"></h3>

                <div class="mb-6">
                    <h4 class="text-xl font-semibold text-blue-300 mb-2">Estructura del Tema:</h4>
                    <table class="w-full text-left table-auto border-collapse">
                        <thead>
                            <tr class="bg-gray-700">
                                <th class="p-2 border border-gray-600">Sección</th>
                                <th class="p-2 border border-gray-600">Compases</th>
                                <th class="p-2 border border-gray-600">Acordes</th>
                            </tr>
                        </thead>
                        <tbody id="song-structure-table-body">
                            <!-- Contenido de la tabla aquí -->
                        </tbody>
                    </table>
                </div>

                <div class="mb-6">
                    <h4 class="text-xl font-semibold text-blue-300 mb-2">Diagramas de Acordes:</h4>
                    <div id="chord-diagrams-container" class="flex flex-wrap justify-center gap-4 mb-4">
                        <!-- Los diagramas de acordes se insertarán aquí -->
                    </div>
                </div>

                <div class="mb-6">
                    <h4 class="text-xl font-semibold text-blue-300 mb-2">Patrón de Rasgueo Sugerido:</h4>
                    <div id="strum-pattern-container" class="flex justify-center items-center p-4 rounded-md bg-gray-900">
                        <!-- El patrón de rasgueo se insertará aquí -->
                    </div>
                </div>

                <div class="mb-6">
                    <h4 class="text-xl font-semibold text-blue-300 mb-2">Melodía (Tablatura):</h4>
                    <div class="bg-gray-900 p-4 rounded-md overflow-x-auto">
                        <svg id="melody-tablature-svg" class="w-full" height="150" viewBox="0 0 800 150"></svg>
                    </div>
                </div>

                <div class="mb-6">
                    <h4 class="text-xl font-semibold text-blue-300 mb-2">Intención del Solo:</h4>
                    <p id="solo-intention-text" class="text-base"></p>
                </div>

                <div class="mb-6">
                    <h4 class="text-xl font-semibold text-blue-300 mb-2">Propuesta de Solo (Notas):</h4>
                    <p id="solo-proposal-text" class="text-base"></p>
                </div>

                <div class="flex justify-end gap-4 mt-8">
                    <button id="print-button" class="px-6 py-3 bg-blue-600 text-white font-bold rounded-lg shadow-lg hover:bg-blue-700 transition duration-300">
                        Imprimir
                    </button>
                    <button id="export-midi-button" class="px-6 py-3 bg-purple-600 text-white font-bold rounded-lg shadow-lg hover:bg-purple-700 transition duration-300">
                        Exportar a MIDI
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tuner Modal -->
    <div id="tuner-modal" class="tuner-modal hidden">
        <div class="tuner-content">
            <button id="close-tuner-button" class="tuner-close-button">&times;</button>
            <h2 class="text-3xl font-bold text-orange-400 mb-4">¡Afinador de Guitarra!</h2>
            <p class="text-lg text-blue-300 mb-4">¡Toca una cuerda para afinarla!</p>

            <div class="tuner-controls">
                <label for="tuner-tuning-select" class="text-lg font-semibold text-blue-300">Afinación:</label>
                <select id="tuner-tuning-select">
                    <!-- Options populated by JS -->
                </select>

                <label for="tuner-strings-select" class="text-lg font-semibold text-blue-300">Cuerdas:</label>
                <select id="tuner-strings-select">
                    <option value="6">6 cuerdas</option>
                    <option value="7">7 cuerdas</option>
                    <option value="8">8 cuerdas</option>
                </select>

                <div class="w-full flex flex-col items-center mt-4">
                    <label for="a4-frequency-slider" class="text-lg font-semibold text-blue-300">Frecuencia de A4:</label>
                    <input type="range" id="a4-frequency-slider" min="420" max="480" value="440" class="w-full max-w-xs mt-2">
                    <span id="a4-frequency-display" class="text-xl font-bold text-orange-300 mt-2">440 Hz</span>
                </div>
            </div>

            <div class="tuner-note-display" id="tuner-note">--</div>
            <div class="tuner-cents-display" id="tuner-cents">-- Cents</div>

            <div class="tuner-needle-container">
                <div class="tuner-range-indicator flat" style="width: 45%;"></div>
                <div class="tuner-range-indicator sharp" style="width: 45%;"></div>
                <div class="tuner-center-line"></div>
                <div class="tuner-needle" style="transform: rotate(0deg);"></div>
            </div>

            <div class="tuner-controls mt-6">
                <button id="start-tuner-button">Iniciar Afinador</button>
                <button id="stop-tuner-button">Detener Afinador</button>
            </div>
        </div>
    </div>

    <!-- Metronome Modal -->
    <div id="metronome-modal" class="metronome-modal hidden">
        <div class="metronome-content">
            <button id="close-metronome-button" class="metronome-close-button">&times;</button>
            <h2 class="text-3xl font-bold text-orange-400 mb-4">¡Metrónomo Súper Pro!</h2>

            <div class="metronome-display" id="metronome-bpm-display">120 BPM</div>

            <div class="metronome-controls">
                <label for="bpm-slider" class="text-lg font-semibold text-blue-300">Tempo (BPM):</label>
                <input type="range" id="bpm-slider" min="40" max="240" value="120">
                <label for="beats-per-measure-select" class="text-lg font-semibold text-blue-300">Golpes por compás:</label>
                <select id="beats-per-measure-select">
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4" selected>4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                </select>
                <div id="beat-indicators" class="flex justify-center mt-4 w-full">
                    <!-- Beat indicators will be dynamically added here -->
                </div>
            </div>

            <div class="metronome-controls mt-6">
                <button id="start-metronome-button">Iniciar Metrónomo</button>
                <button id="stop-metronome-button">Detener Metrónomo</button>
            </div>
        </div>
    </div>

    <!-- Chord Options Modal -->
    <div id="chord-options-modal" class="chord-options-modal hidden">
        <div class="chord-options-content">
            <button id="close-chord-options-button" class="chord-options-close-button">&times;</button>
            <h2 class="text-3xl font-bold text-orange-400 mb-4" id="chord-options-title">Opciones de Acorde: --</h2>
            <div id="chord-options-container" class="chord-options-container">
                <!-- Chord diagrams will be inserted here -->
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <footer class="app-footer">
        Desarrollado por JuCa Noiz | Aural Flux®
    </footer>

    <script>
        // Static musical data provided by the user
        const staticMusicalData = {
            "notas": ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"],
            "notas_enarmonicas": {
                "C#": "Db", "D#": "Eb", "F#": "Gb", "G#": "Ab", "A#": "Bb"
            },
            "grados": ["I", "II", "III", "IV", "V", "VI", "VII"],
            "intervalos": [
                "Unísono", "Segunda menor", "Segunda mayor", "Tercera menor", "Tercera mayor",
                "Cuarta justa", "Tritono", "Quinta justa", "Sexta menor", "Sexta mayor",
                "Séptima menor", "Séptima mayor", "Octava"
            ],
            "modos": [
                "Jónico (Mayor)", "Dórico", "Frigio", "Lidio", "Mixolidio", "Eólico (Menor)", "Locrio"
            ],
            "escalas": {
                "mayores": ["C", "G", "D", "A", "E", "B", "F#", "C#", "F", "Bb", "Eb", "Ab", "Db", "Gb", "Cb"],
                "menores": ["A", "E", "B", "F#", "C#", "G#", "D#", "A#", "D", "G", "C", "F", "Bb", "Eb", "Ab"],
                "pentatonicas": ["Mayor", "Menor", "Blues"],
                "otros_tipos": ["Armónica menor", "Melódica menor", "Escala cromática", "Escala disminuida", "Escala aumentada"]
            },
            "acordes": {
                "tipos_basicos": ["Mayor", "Menor", "Disminuido", "Aumentado"],
                "cuatriadas": ["Maj7", "m7", "7", "m7b5", "dim7", "aug7", "mMaj7"],
                "extendidos": ["9", "11", "13", "add9", "sus2", "sus4"],
                "acordes_por_funcion": {
                    "tonica": ["I", "vi", "iii"],
                    "subdominante": ["ii", "IV"],
                    "dominante": ["V", "vii°"]
                }
            },
            "afinaciones": {
                "estandar": ["EADGBE"],
                "drop": {
                    "Drop D": "DADGBE",
                    "Drop C": "CGCFAD",
                    "Drop B": "B F# B E G# C#",
                    "Drop A": "A E A D F# B"
                },
                "afinaciones_7_cuerdas": {
                    "Estándar": "BEADGBE",
                    "Drop A": "AEADGBE"
                },
                "afinaciones_8_cuerdas": {
                    "Estándar": "F#BEADGBE",
                    "Drop E": "EBEADGBE"
                }
            },
            "compases": [
                "2/4", "3/4", "4/4", "5/4", "6/8", "7/8", "9/8", "12/8", "11/16", "15/16"
            ],
            "armonias": {
                "armonias_diatonicas": {
                    "mayor": ["I", "ii", "iii", "IV", "V", "vi", "vii°"],
                    "menor": ["i", "ii°", "III", "iv", "v", "VI", "VII"]
                },
                "progresiones_comunes": [
                    ["I", "IV", "V", "I"],
                    ["ii", "V", "I"],
                    ["I", "vi", "IV", "V"],
                    ["I", "V", "vi", "IV"]
                ]
            },
            "armaduras_clave": {
                "sostenidos": {
                    "G": 1, "D": 2, "A": 3, "E": 4, "B": 5, "F#": 6, "C#": 7
                },
                "bemoles": {
                    "F": 1, "Bb": 2, "Eb": 3, "Ab": 4, "Db": 5, "Gb": 6, "Cb": 7
                }
            },
            "tempos": {
                "lento": "40-60 BPM",
                "andante": "76-108 BPM",
                "moderado": "108-120 BPM",
                "rápido": "120-168 BPM",
                "muy_rápido": "168-208 BPM"
            },
            "simbolos_partitura": [
                "Clave de Sol", "Clave de Fa", "Compás", "Silencios", "Ligaduras", "Corcheas", "Semicorcheas",
                "Fermata", "Calderón", "Repeticiones", "Da Capo", "Coda", "Trinos", "Glissando"
            ],
            "notacion_musical": {
                "sistema_americano": ["C", "D", "E", "F", "G", "A", "B"],
                "sistema_latino": ["Do", "Re", "Mi", "Fa", "Sol", "La", "Si"]
            }
        };


        // Array con las notas del Círculo de Quintas en orden (tonalidades mayores)
        const circleNotes = [
            "C", "G", "D", "A", "E", "B", "F#", "Db", "Ab", "Eb", "Bb", "F"
        ];

        // Objeto que mapea cada tonalidad mayor a su relativa menor
        const relativeMinors = {
            "C": "Am", "G": "Em", "D": "Bm", "A": "F#m", "E": "C#m", "B": "G#m",
            "F#": "D#m", "Db": "Bbm", "Ab": "Fm", "Eb": "Cm", "Bb": "Gm", "F": "Dm"
        };

        // Mapa inverso para encontrar la tonalidad mayor relativa a partir de una menor
        const relativeMajors = {};
        for (const major in relativeMinors) {
            relativeMajors[relativeMinors[major]] = major;
        }

        // Escala cromática con sostenidos
        const fullChromaticScaleSharps = [
            "C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"
        ];

        // Escala cromática con bemoles
        const fullChromaticScaleFlats = [
            "C", "Db", "D", "Eb", "E", "F", "Gb", "G", "Ab", "A", "Bb", "B"
        ];

        // Mapa para manejar las notas enarmónicas (ej. C# es lo mismo que Db)
        // Esto es crucial para que al resaltar, se reconozcan las notas equivalentes
        const canonicalNotesMap = {
            "C": "C", "C#": "C#", "Db": "C#",
            "D": "D", "D#": "D#", "Eb": "D#",
            "E": "E", "F": "F", "F#": "F#", "Gb": "F#",
            "G": "G", "G#": "G#", "Ab": "G#",
            "A": "A", "A#": "A#", "Bb": "A#",
            "B": "B"
            // E#, B#, Cb, Fb are less common in circle of fifths context but can be added if needed
        };

        // Función para obtener la forma "canónica" (estándar) de una nota
        function getCanonicalNote(note) {
            // Si la nota es una menor (ej. "Am"), solo tomamos la raíz ("A")
            const baseNote = note.replace('m', '');
            return canonicalNotesMap[baseNote] || baseNote;
        }

        // Helper para obtener el índice cromático de una nota
        function getChromaticIndex(note) {
            // Primero intenta con sostenidos, luego con bemoles
            let index = fullChromaticScaleSharps.indexOf(note);
            if (index === -1) {
                index = fullChromaticScaleFlats.indexOf(note);
            }
            return index;
        }

        // Definiciones de los modos: intervalos en semitonos relativos a la tónica
        const modesIntervals = {
            "Jónico (Mayor)": { intervals: [0, 2, 4, 5, 7, 9, 11], formula: "T - T - S - T - T - T - S", theory: "El modo Jónico es nuestra escala mayor de toda la vida. Suena brillante y feliz. ¡Ideal para melodías principales y progresiones alegres!" },
            "Dórico": { intervals: [0, 2, 3, 5, 7, 9, 10], formula: "T - S - T - T - T - S - T", theory: "El modo Dórico tiene un sonido menor pero con un toque de blues o jazz, gracias a su 6ª mayor. ¡Perfecto para un ambiente melancólico pero con onda!" },
            "Frigio": { intervals: [0, 1, 3, 5, 7, 8, 10], formula: "S - T - T - T - S - T - T", theory: "El modo Frigio es oscuro y exótico por su 2ª menor. ¡Piensa en flamenco o metal! Le da un toque dramático a tus rolas." },
            "Lidio": { intervals: [0, 2, 4, 6, 7, 9, 11], formula: "T - T - T - S - T - T - S", theory: "El modo Lidio es como la escala mayor pero con una 4ª aumentada. Suena etéreo, soñador y muy 'cinemático'. ¡Para darle un toque mágico a tus composiciones!" },
            "Mixolidio": { intervals: [0, 2, 4, 5, 7, 9, 10], formula: "T - T - S - T - T - S - T", theory: "El modo Mixolidian es una escala mayor con una 7ª menor. Es la escala del blues y el rock por excelencia. ¡Suena a 'acorde dominante' y te da ese feeling de resolución!" },
            "Eólico (Menor)": { intervals: [0, 2, 3, 5, 7, 8, 10], formula: "T - S - T - T - S - T - T", theory: "El modo Eólico es la escala menor natural. Suena triste, introspectivo, melancólico. ¡Es la base de la mayoría de las canciones en tonalidad menor!" },
            "Locrio": { intervals: [0, 1, 3, 5, 6, 8, 10], formula: "S - T - T - S - T - T - T", theory: "El modo Lócrio es el más disonante por su 2ª menor y 5ª disminuida. Es inestable y se usa poco melódicamente, ¡pero puede crear tensión extrema en contextos experimentales!" }
        };

        // Nombres de los intervalos para mostrar su función en la composición
        const intervalNames = staticMusicalData.intervalos;

        // Función para obtener el nombre del intervalo basado en la diferencia de semitonos
        function getIntervalName(semitones) {
            // Mapea 0 semitonos a "Tónica"
            if (semitones === 0) return "Tónica";
            // Clasifica las notas de resolución y descanso
            if (semitones === 7) return "Dominante"; // Quinta justa
            if (semitones === 11) return "Sensible"; // Séptima mayor (leading tone)
            if (semitones === 4) return "Mediante"; // Tercera mayor
            if (semitones === 9) return "Submediante"; // Sexta mayor
            if (semitones === 5) return "Subdominante"; // Cuarta justa
            if (semitones === 2) return "Supertónica"; // Segunda mayor
            if (semitones === 3) return "Mediante menor"; // Tercera menor (for minor scales)
            if (semitones === 8) return "Submediante menor"; // Sexta menor (for minor scales)
            if (semitones === 10) return "Subtónica"; // Séptima menor (for minor scales)
            if (semitones === 1) return "Segunda menor"; // For Phrygian/Locrian
            if (semitones === 6) return "Tritono"; // Tritone (for Locrian)

            return intervalNames[semitones % 12]; // Fallback to generic interval name
        }

        // Función para generar las notas de una escala/modo dada una tónica y un modo, incluyendo sus intervalos
        function getModeNotesWithIntervals(rootNote, modeName) {
            const modeData = modesIntervals[modeName];
            if (!modeData) {
                console.error("Modo no encontrado:", modeName);
                return [];
            }
            const intervals = modeData.intervals;

            let modeNotes = [];
            const rootIndex = getChromaticIndex(rootNote);
            if (rootIndex === -1) {
                console.error("Nota raíz no válida:", rootNote);
                return [];
            }

            // Heurística simple para preferir sostenidos o bemoles en la ortografía de las notas
            const preferFlats = rootNote.includes('b') || ['F', 'Bb', 'Eb', 'Ab', 'Db', 'Gb', 'Cb'].includes(rootNote);
            const chromaticScaleToUse = preferFlats ? fullChromaticScaleFlats : fullChromaticScaleSharps;

            intervals.forEach(semitones => {
                const noteIndex = (rootIndex + semitones + 12) % 12; // Asegura un índice positivo
                modeNotes.push({
                    note: chromaticScaleToUse[noteIndex],
                    interval: getIntervalName(semitones),
                    semitonesFromRoot: semitones // Store semitones to classify for legend
                });
            });
            return modeNotes;
        }

        // Dimensiones y propiedades para el SVG del Círculo de Quintas
        const SVG_SIZE = 800; // Aumentado para hacer el círculo mucho más grande
        const CENTER_X = SVG_SIZE / 2; // Centro en X
        const CENTER_Y = SVG_SIZE / 2; // Centro en Y
        const OUTER_RADIUS = 320; // Aumentado (original 200 * 1.6)
        const INNER_RADIUS = 176; // Aumentado (original 110 * 1.6)
        const NOTE_CIRCLE_RADIUS = 40; // Aumentado (original 35)
        const KEY_SIGNATURE_RADIUS = 360; // Aumentado (original 290 * 1.25)

        // Variables para llevar el control de la tonalidad y el modo seleccionados
        let currentHighlightedKey = null; // Siempre será una tonalidad MAYOR (ej. "C", "G")
        let currentSelectedMode = "Jónico (Mayor)"; // Modo por defecto
        let currentFretboardPosition = "Full Fretboard"; // Posición del diapasón por defecto
        let currentSongIdea = null; // Global variable to store the generated song idea

        // Fretboard constants
        const NUM_FRETS = 24;
        const NUM_STRINGS = 6;
        const FRETBOARD_WIDTH = 800; // SVG viewBox width
        const FRETBOARD_HEIGHT = 250; // SVG viewBox height
        const FRET_SPACING = FRETBOARD_WIDTH / (NUM_FRETS + 1); // Spacing for frets, including nut
        const STRING_SPACING = FRETBOARD_HEIGHT / (NUM_STRINGS + 1);

        // Standard guitar tuning (EADGBe) - Chromatic index for open strings
        // Low E (6th string) to High E (1st string)
        const openStringNotes = [
            { name: "E", octave: 4, index: getChromaticIndex("E") }, // 1st string (high E)
            { name: "B", octave: 3, index: getChromaticIndex("B") }, // 2nd string
            { name: "G", octave: 3, index: getChromaticIndex("G") }, // 3rd string
            { name: "D", octave: 3, index: getChromaticIndex("D") }, // 4th string
            { name: "A", octave: 2, index: getChromaticIndex("A") }, // 5th string
            { name: "E", octave: 2, index: getChromaticIndex("E") }  // 6th string (low E)
        ];

        // Map note names to MIDI numbers (C4 = 60). Base MIDI for C0 is 12.
        const noteToSemitonesFromC = {
            "C": 0, "C#": 1, "D": 2, "D#": 3, "E": 4, "F": 5, "F#": 6, "G": 7, "G#": 8, "A": 9, "A#": 10, "B": 11,
            "Db": 1, "Eb": 3, "Gb": 6, "Ab": 8, "Bb": 10
        };

        // Helper function to convert note name (e.g., "C", "C#", "Db") to MIDI note number
        function getMidiNoteNumber(noteName, octave) {
            let semitonesFromC = noteToSemitonesFromC[noteName];
            if (semitonesFromC === undefined) {
                console.warn(`Note name "${noteName}" not found in noteToSemitonesFromC map.`);
                return -1; // Indicate error
            }
            // C0 is MIDI 12. So, C4 is 12 + (4 * 12) = 60.
            return semitonesFromC + (octave * 12) + 12;
        }

        // Helper to get the fret and string for a given note
        function getFretAndString(noteName, targetOctave) {
            const targetMidi = getMidiNoteNumber(noteName, targetOctave);
            if (targetMidi === -1) return null;

            // Iterate through strings from low E (index 5) to high E (index 0)
            // to prioritize finding the note on a lower string if possible.
            for (let stringIdx = NUM_STRINGS - 1; stringIdx >= 0; stringIdx--) {
                const openNoteMidi = getMidiNoteNumber(openStringNotes[stringIdx].name.toUpperCase(), openStringNotes[stringIdx].octave);
                for (let fret = 0; fret <= NUM_FRETS; fret++) {
                    if ((openNoteMidi + fret) === targetMidi) {
                        return { string: stringIdx, fret: fret };
                    }
                }
            }
            return null; // Note not found on fretboard within 24 frets
        }

        // Scale Position Patterns based on user's examples for A minor, converted to relative frets
        // `patternLowestFret`: The lowest absolute fret found in the user's example for this position (for A minor).
        // `relativeFrets`: Array of arrays, where each inner array contains the fret numbers relative to `patternLowestFret` for each string.
        // `rootStringIndex`: The index of the string where the root of the minor scale is typically found for this shape.
        // `rootFretInPattern`: The relative fret (to `patternLowestFret`) where the root of the minor scale is found on `rootStringIndex`.
        const scalePositionPatterns = {
            "Full Fretboard": null,
            "Position 1": { // Em shape, for Am starts at fret 5 (root on 6th string)
                patternLowestFret: 4, // Lowest fret in the example (G string, fret 4)
                relativeFrets: [
                    [1, 3, 4], // e (high): 5, 7, 8 (relative to fret 4)
                    [1, 2, 4], // B: 5, 6, 8
                    [0, 1, 3], // G: 4, 5, 7
                    [1, 3],    // D: 5, 7
                    [1, 3],    // A: 5, 7
                    [1, 3, 4]  // E (low): 5, 7, 8
                ],
                rootStringIndex: 5, // Low E string (index 5)
                rootFretInPattern: 1 // Root (A) is at absolute fret 5, relative to patternLowestFret (4) -> 5-4 = 1
            },
            "Position 2": { // Dm shape, for Am starts at fret 7 (root on 4th string)
                patternLowestFret: 5, // Lowest fret in the example (G string, fret 5; D string, fret 5)
                relativeFrets: [
                    [2, 3, 5], // e (high): 7, 8, 10
                    [1, 3, 5], // B: 6, 8, 10
                    [0, 2, 4], // G: 5, 7, 9
                    [0, 2, 4], // D: 5, 7, 9
                    [2, 3, 5], // A: 7, 8, 10
                    [2, 3, 5]  // E (low): 7, 8, 10
                ],
                rootStringIndex: 3, // D string (index 3)
                rootFretInPattern: 2 // Root (A) is at absolute fret 7, relative to patternLowestFret (5) -> 7-5 = 2
            },
            "Position 3": { // Cm shape, for Am starts at fret 10 (root on 5th string)
                patternLowestFret: 7, // Lowest fret in the example (G string, fret 7; D string, fret 7)
                relativeFrets: [
                    [1, 3, 5], // e (high): 8, 10, 12
                    [1, 3, 4], // B: 8, 10, 11
                    [0, 2, 3], // G: 7, 9, 10
                    [0, 2, 3], // D: 7, 9, 10
                    [0, 1, 3], // A: 7, 8, 10
                    []         // E (low) - user's example doesn't show notes here
                ],
                rootStringIndex: 4, // A string (index 4)
                rootFretInPattern: 3 // Root (A) is at absolute fret 10, relative to patternLowestFret (7) -> 10-7 = 3
            },
            "Position 4": { // Am shape, for Am starts at fret 12 (root on 6th string)
                patternLowestFret: 9, // Lowest fret in the example (G string, fret 9)
                relativeFrets: [
                    [1, 3, 4], // e (high): 10, 12, 13
                    [1, 2, 4], // B: 10, 11, 13
                    [0, 1, 3], // G: 9, 10, 12
                    [1, 3, 5], // D: 10, 12, 14
                    [1, 3, 4], // A: 10, 12, 13
                    [1, 3, 4]  // E (low): 10, 12, 13
                ],
                rootStringIndex: 5, // Low E string (index 5)
                rootFretInPattern: 3 // Root (A) is at absolute fret 12, relative to patternLowestFret (9) -> 12-9 = 3
            },
            "Position 5": { // Gm shape, for Am starts at fret 3 (root on 6th string)
                patternLowestFret: 2, // Lowest fret in the example (D string, fret 2)
                relativeFrets: [
                    [1, 3, 5], // e (high): 3, 5, 7
                    [1, 3, 4], // B: 3, 5, 6
                    [0, 2, 3], // G: 2, 4, 5
                    [0, 1, 3], // D: 2, 3, 5
                    [1, 3, 5], // A: 3, 5, 7
                    [1, 3, 5]  // E (low): 3, 5, 7
                ],
                rootStringIndex: 5, // Low E string (index 5)
                rootFretInPattern: 1 // Root (A) is at absolute fret 3, relative to patternLowestFret (2) -> 3-2 = 1
            }
        };


        // Function to generate tablature string
        function generateTablatureString(melodyNotes) {
            const tabLines = Array(NUM_STRINGS).fill('').map((_, i) => openStringNotes[i].name.charAt(0).toUpperCase() + '|');
            const noteSlotWidth = 4; // Width of a slot for a note (e.g., "---5" or "----")

            // Determine the maximum length needed for the tablature lines based on number of notes
            const maxNotes = melodyNotes.length;
            // No need to calculate totalCharsForNotes and initialPadding for pre-filling dashes,
            // as the loop below will build the strings incrementally.

            let currentXOffset = 0; // Tracks the horizontal position for notes in terms of "slots"

            // Initialize all tab lines with enough dashes to cover all notes
            const estimatedTotalLength = (maxNotes * noteSlotWidth) + (Math.ceil(maxNotes / 4) * 1) + 10; // +1 for each bar, + some buffer
            for (let i = 0; i < NUM_STRINGS; i++) {
                tabLines[i] += '-'.repeat(estimatedTotalLength);
            }


            melodyNotes.forEach((note, noteIndex) => {
                const noteName = note.match(/[A-G][b#]?/)[0];
                const octave = parseInt(note.match(/\d/)[0]);
                const fretInfo = getFretAndString(noteName, octave);

                // Calculate the start position for this note's fret number within its slot
                const startCharIdx = currentXOffset;

                for (let stringIdx = 0; stringIdx < NUM_STRINGS; stringIdx++) {
                    let lineArray = tabLines[stringIdx].split('');
                    if (fretInfo && stringIdx === fretInfo.string) {
                        const fretString = fretInfo.fret.toString();
                        // Place fret number, right-aligned in its slot
                        const fretStart = startCharIdx + (noteSlotWidth - fretString.length);
                        for (let k = 0; k < fretString.length; k++) {
                            lineArray[fretStart + k] = fretString[k];
                        }
                    }
                    tabLines[stringIdx] = lineArray.join('');
                }

                currentXOffset += noteSlotWidth; // Move to the next slot

                // Add measure bar (simplified: every 4 notes, but not after the very last note)
                if ((noteIndex + 1) % 4 === 0 && noteIndex !== melodyNotes.length - 1) {
                     for (let i = 0; i < NUM_STRINGS; i++) {
                        let lineArray = tabLines[i].split('');
                        lineArray.splice(currentXOffset, 0, '|'); // Insert bar at current offset
                        tabLines[i] = lineArray.join('');
                     }
                     currentXOffset += 1; // Account for the inserted bar
                }
            });

            // Ensure all lines end with a bar and trim excess dashes
            for (let i = 0; i < NUM_STRINGS; i++) {
                // Find the last non-dash character position
                let lastCharPos = tabLines[i].length - 1;
                while (lastCharPos >= 0 && tabLines[i][lastCharPos] === '-') {
                    lastCharPos--;
                }
                tabLines[i] = tabLines[i].substring(0, lastCharPos + 1);

                if (!tabLines[i].endsWith('|')) {
                    tabLines[i] += '|';
                }
            }

            return tabLines.join('\n');
        }

        // Función para llenar el selector de modos griegos
        function populateModeDropdown() {
            const modeSelect = document.getElementById("mode-select");
            // Clear existing options
            modeSelect.innerHTML = '';
            staticMusicalData.modos.forEach(modeName => {
                const option = document.createElement("option");
                option.value = modeName;
                option.textContent = modeName;
                modeSelect.appendChild(option);
            });
            // Establece el modo por defecto
            modeSelect.value = currentSelectedMode;

            // Agrega un listener para cuando cambie el modo
            modeSelect.addEventListener("change", (event) => {
                currentSelectedMode = event.target.value;
                updateModeDisplayAndFretboard(); // Llama a la nueva función para actualizar
            });
        }
              
        // Key Signatures for the Circle of Fifths visual (simplified positions)
        // Each entry defines the sharps/flats and their relative Y positions on a mini-staff.
        // Y positions are relative to a conceptual center line of the mini-staff.
        const circleKeySignatureSymbols = {
            "C": { sharps: 0, flats: 0, symbols: [] },
            "G": { sharps: 1, flats: 0, symbols: [{ sym: "#", y: 0 }] }, // F#
            "D": { sharps: 2, flats: 0, symbols: [{ sym: "#", y: 0 }, { sym: "#", y: -10 }] }, // F#, C#
            "A": { sharps: 3, flats: 0, symbols: [{ sym: "#", y: 0 }, { sym: "#", y: -10 }, { sym: "#", y: 5 }] }, // F#, C#, G#
            "E": { sharps: 4, flats: 0, symbols: [{ sym: "#", y: 0 }, { sym: "#", y: -10 }, { sym: "#", y: 5 }, { sym: "#", y: -5 }] }, // F#, C#, G#, D#
            "B": { sharps: 5, flats: 0, symbols: [{ sym: "#", y: 0 }, { sym: "#", y: -10 }, { sym: "#", y: 5 }, { sym: "#", y: -5 }, { sym: "#", y: -15 }] }, // F#, C#, G#, D#, A#
            "F#": { sharps: 6, flats: 0, symbols: [{ sym: "#", y: 0 }, { sym: "#", y: -10 }, { sym: "#", y: 5 }, { sym: "#", y: -5 }, { sym: "#", y: -15 }, { sym: "#", y: 10 }] }, // F#, C#, G#, D#, A#, E#
            "Db": { sharps: 0, flats: 5, symbols: [{ sym: "b", y: -5 }, { sym: "b", y: 5 }, { sym: "b", y: -15 }, { sym: "b", y: -10 }, { sym: "b", y: 0 }] }, // Db, Gb, Cb, Fb, Bb
            "Ab": { sharps: 0, flats: 4, symbols: [{ sym: "b", y: -5 }, { sym: "b", y: 5 }, { sym: "b", y: -15 }, { sym: "b", y: -10 }] }, // Db, Gb, Cb, Fb
            "Eb": { sharps: 0, flats: 3, symbols: [{ sym: "b", y: -5 }, { sym: "b", y: 5 }, { sym: "b", y: -15 }] }, // Db, Gb, Cb
            "Bb": { sharps: 0, flats: 2, symbols: [{ sym: "b", y: -5 }, { sym: "b", y: 5 }] }, // Db, Gb
            "F": { sharps: 0, flats: 1, symbols: [{ sym: "b", y: -5 }] } // Db
        };

        // Function to draw a miniature key signature around the circle
        function drawMiniKeySignature(svg, majorNote, angle) {
            const keyInfo = circleKeySignatureSymbols[majorNote];
            if (!keyInfo) return;

            const group = document.createElementNS("http://www.w3.org/2000/svg", "g");
            group.setAttribute("class", "key-signature-group");

            // Calculate position for the center of the mini-staff
            const miniStaffCenterX = CENTER_X + KEY_SIGNATURE_RADIUS * Math.cos(angle);
            const miniStaffCenterY = CENTER_Y + KEY_SIGNATURE_RADIUS * Math.sin(angle);

            const staffWidth = 40;
            const staffHeight = 20;
            const staffLineSpacing = staffHeight / 4; // 5 lines, 4 spaces
            const staffStartX = miniStaffCenterX - (staffWidth / 2);
            const staffStartY = miniStaffCenterY - (staffHeight / 2);

            // Draw 5 mini staff lines
            for (let i = 0; i < 5; i++) {
                const y = staffStartY + (i * staffLineSpacing);
                const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                line.setAttribute("x1", staffStartX);
                line.setAttribute("y1", y);
                line.setAttribute("x2", staffStartX + staffWidth);
                line.setAttribute("y2", y);
                line.setAttribute("class", "mini-staff-line");
                group.appendChild(line);
            }

            // Draw a simplified treble clef (scaled down) - IMPROVED PATH
            const clefPath = "M 10 18 C 10 14 12 11 15 11 C 18 11 20 14 20 18 C 20 22 18 25 15 25 C 12 25 10 22 10 18 Z M 15 11 L 15 0 M 15 25 L 15 30"; // More accurate treble clef path
            const clef = document.createElementNS("http://www.w3.org/2000/svg", "path");
            clef.setAttribute("d", clefPath);
            clef.setAttribute("class", "mini-clef");
            clef.setAttribute("transform", `translate(${staffStartX - 10}, ${staffStartY - 15}) scale(0.7)`); // Adjust position and scale
            group.appendChild(clef);


            // Draw sharps/flats
            keyInfo.symbols.forEach((symbol, index) => {
                const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                text.setAttribute("x", staffStartX + staffWidth / 4 + (index * 6)); // Adjust X spacing
                text.setAttribute("y", miniStaffCenterY + symbol.y);
                text.setAttribute("dominant-baseline", "middle");
                text.setAttribute("text-anchor", "middle");
                text.setAttribute("class", "key-symbol");
                text.textContent = symbol.sym;
                group.appendChild(text);
            });

            svg.appendChild(group);
        }

        // Función principal para dibujar el Círculo de Quintas en SVG
        function drawCircleOfFifths() {
            console.log("drawCircleOfFifths called.");
            const container = document.getElementById("circle-container");
            container.innerHTML = ''; // Clear previous SVG
            const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.setAttribute("viewBox", `0 0 ${SVG_SIZE} ${SVG_SIZE}`);
            svg.setAttribute("class", "w-full h-full"); 

            

            // Dibuja el círculo central (estético)
            const centerCircle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            centerCircle.setAttribute("cx", CENTER_X);
            centerCircle.setAttribute("cy", CENTER_Y);
            centerCircle.setAttribute("r", INNER_RADIUS / 2); // Un poco más pequeño que el círculo interior
            centerCircle.setAttribute("class", "center-circle");
            svg.appendChild(centerCircle);

            // Dibuja las líneas que conectan las notas adyacentes en el círculo exterior
            for (let i = 0; i < circleNotes.length; i++) {
                const startAngle = (i * 30 - 90) * Math.PI / 180; // Ángulo en radianes, C a las 12
                const endAngle = ((i + 1) * 30 - 90) * Math.PI / 180;

                const startX = CENTER_X + OUTER_RADIUS * Math.cos(startAngle);
                const startY = CENTER_Y + OUTER_RADIUS * Math.sin(startAngle);
                const endX = CENTER_X + OUTER_RADIUS * Math.cos(endAngle);
                const endY = CENTER_Y + OUTER_RADIUS * Math.sin(endAngle);

                const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                line.setAttribute("x1", startX);
                line.setAttribute("y1", startY);
                line.setAttribute("x2", endX);
                line.setAttribute("y2", endY);
                line.setAttribute("class", "line");
                svg.appendChild(line);
            }

            // Dibuja cada nota alrededor de los círculos (mayor y menor)
            circleNotes.forEach((majorNote, index) => {
                const angle = (index * 30 - 90) * Math.PI / 180; // Ángulo para ambas notas (mayor y menor)

                // --- Notas del círculo exterior (Mayores) ---
                const outerX = CENTER_X + OUTER_RADIUS * Math.cos(angle);
                const outerY = CENTER_Y + OUTER_RADIUS * Math.sin(angle);

                const majorNoteGroup = document.createElementNS("http://www.w3.org/2000/svg", "g");
                majorNoteGroup.setAttribute("class", "note-group major"); // Clase 'major'
                majorNoteGroup.setAttribute("data-note-type", "major");
                majorNoteGroup.setAttribute("data-note-value", majorNote); // Guarda el nombre de la nota mayor

                const majorNoteCircle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                majorNoteCircle.setAttribute("cx", outerX);
                majorNoteCircle.setAttribute("cy", outerY);
                majorNoteCircle.setAttribute("r", NOTE_CIRCLE_RADIUS); // Aumentado ligeramente para mejor clic
                majorNoteCircle.setAttribute("class", "note-circle");

                const majorNoteText = document.createElementNS("http://www.w3.org/2000/svg", "text");
                majorNoteText.setAttribute("x", outerX);
                majorNoteText.setAttribute("y", outerY + 8);
                majorNoteText.setAttribute("text-anchor", "middle");
                majorNoteText.setAttribute("class", "note-text");
                majorNoteText.textContent = majorNote;

                majorNoteGroup.appendChild(majorNoteCircle);
                majorNoteGroup.appendChild(majorNoteText);
                svg.appendChild(majorNoteGroup);

                // Agrega listener de clic a la nota mayor
                majorNoteGroup.addEventListener("click", () => {
                    highlightCircleNotes(majorNote, "major"); // Pasa el tipo de nota
                    updateModeDisplayAndFretboard(); // Actualiza la sección de modos y el diapasón
                });

                // --- Notas del círculo interior (Menores Relativas) ---
                const minorNote = relativeMinors[majorNote];
                const innerX = CENTER_X + INNER_RADIUS * Math.cos(angle);
                const innerY = CENTER_Y + INNER_RADIUS * Math.sin(angle);

                const minorNoteGroup = document.createElementNS("http://www.w3.org/2000/svg", "g");
                minorNoteGroup.setAttribute("class", "note-group minor"); // Clase 'minor'
                minorNoteGroup.setAttribute("data-note-type", "minor");
                minorNoteGroup.setAttribute("data-note-value", minorNote); // Guarda el nombre de la nota menor
                minorNoteGroup.setAttribute("data-relative-major-value", majorNote); // Guarda su mayor relativa

                const minorNoteCircle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                minorNoteCircle.setAttribute("cx", innerX);
                minorNoteCircle.setAttribute("cy", innerY);
                minorNoteCircle.setAttribute("r", NOTE_CIRCLE_RADIUS * 0.8); // Un poco más pequeñas
                minorNoteCircle.setAttribute("class", "minor-note-circle");

                const minorNoteTextElement = document.createElementNS("http://www.w3.org/2000/svg", "text"); // Renamed variable
                minorNoteTextElement.setAttribute("x", innerX);
                minorNoteTextElement.setAttribute("y", innerY + 6); // Ajusta Y para texto más pequeño
                minorNoteTextElement.setAttribute("text-anchor", "middle");
                minorNoteTextElement.setAttribute("class", "minor-note-text");
                minorNoteTextElement.textContent = minorNote;

                minorNoteGroup.appendChild(minorNoteCircle);
                minorNoteGroup.appendChild(minorNoteTextElement); // Use the renamed variable
                svg.appendChild(minorNoteGroup);

                // Agrega listener de clic a la nota menor
                minorNoteGroup.addEventListener("click", () => {
                    highlightCircleNotes(minorNote, "minor"); // Pasa el tipo de nota
                    updateModeDisplayAndFretboard();
                });

                // --- Línea que conecta la nota mayor con su relativa menor ---
                const relativeLine = document.createElementNS("http://www.w3.org/2000/svg", "line");
                relativeLine.setAttribute("x1", outerX);
                relativeLine.setAttribute("y1", outerY);
                relativeLine.setAttribute("x2", innerX);
                relativeLine.setAttribute("y2", innerY);
                relativeLine.setAttribute("class", "relative-line");
                svg.appendChild(relativeLine);

                // --- Dibuja la armadura de clave para cada nota mayor ---
                drawMiniKeySignature(svg, majorNote, angle);
            });

            container.appendChild(svg);
            console.log("Circle SVG appended.");
        }

        // Helper para obtener el nombre de la nota de un índice cromático,
        // prefiriendo sostenidos o bemoles según la tonalidad raíz
        function getNoteNameFromChromaticIndex(index, rootNoteForSpelling) {
            index = (index + 12) % 12; // Asegura que el índice esté entre 0 y 11

            // Heurística simple: si la nota raíz contiene 'b' o es una tonalidad común con bemoles,
            // se prefieren los bemoles. De lo contrario, se prefieren los sostenidos.
            const preferFlats = rootNoteForSpelling.includes('b') || ['F', 'Bb', 'Eb', 'Ab', 'Db', 'Gb', 'Cb'].includes(rootNoteForSpelling);

            if (preferFlats) {
                return fullChromaticScaleFlats[index];
            } else {
                return fullChromaticScaleSharps[index];
            }
        }

        // Colores para las notas de la escala en el diapasón (excluyendo la tónica)
        // Estos colores deben coincidir con la leyenda
        const fretboardNoteColors = {
            "fundamental": "#f6ad55", // Naranja para la tónica
            "resolution": "#63b3ed",  // Azul para notas de resolución (Dominante, Sensible)
            "resting": "#48bb78",     // Verde para notas de descanso (Mediante, Submediante)
            "other": "#9f7aea"        // Morado para otras notas
        };

        // Función para clasificar la función de la nota en la escala
        function classifyNoteFunction(semitones) {
            switch (semitones) {
                case 0: return "fundamental"; // Tónica
                case 7: // Quinta justa (Dominante)
                case 11: return "resolution"; // Séptima mayor (Sensible)
                case 4: // Tercera mayor (Mediante)
                case 9: return "resting"; // Sexta mayor (Submediante)
                default: return "other"; // Cualquier otra nota
            }
        }

        // Función para dibujar el diapasón de la guitarra y resaltar las notas
        function drawFretboard(scaleNotesWithIntervals = [], rootNoteForFretboard = null) {
            console.log("drawFretboard called with:", scaleNotesWithIntervals, rootNoteForFretboard);
            const fretboardSvg = document.getElementById("fretboard-svg");
            fretboardSvg.innerHTML = ''; // Limpia cualquier dibujo anterior

            // Establece el viewBox para el escalado responsivo
            fretboardSvg.setAttribute("viewBox", `0 0 ${FRETBOARD_WIDTH} ${FRETBOARD_HEIGHT}`);

            // Dibuja las cuerdas
            for (let i = 0; i < NUM_STRINGS; i++) {
                const y = (i + 1) * STRING_SPACING; // Posición Y para cada cuerda
                const string = document.createElementNS("http://www.w3.org/2000/svg", "line");
                string.setAttribute("x1", 0);
                string.setAttribute("y1", y);
                string.setAttribute("x2", FRETBOARD_WIDTH);
                string.setAttribute("y2", y);
                string.setAttribute("stroke", "#a0aec0"); // Color de la cuerda (gris)
                string.setAttribute("stroke-width", 1.5);
                fretboardSvg.appendChild(string);
            }

            // Dibuja los trastes (líneas verticales)
            for (let i = 0; i <= NUM_FRETS; i++) {
                const x = i * FRET_SPACING; // Posición X para cada traste
                const fret = document.createElementNS("http://www.w3.org/2000/svg", "line");
                fret.setAttribute("x1", x);
                fret.setAttribute("y1", STRING_SPACING / 2); // Inicia por encima de la primera cuerda
                fret.setAttribute("x2", x);
                fret.setAttribute("y2", FRETBOARD_HEIGHT - STRING_SPACING / 2); // Termina por debajo de la última cuerda
                fret.setAttribute("stroke", "#a0aec0");
                fret.setAttribute("stroke-width", i === 0 ? 5 : 2); // Cejuela más gruesa en el traste 0
                fretboardSvg.appendChild(fret);
            }

            // Dibuja los puntos de referencia (inlays) en el diapasón
            const inlayFrets = [3, 5, 7, 9, 12, 15, 17, 19, 21, 24];
            inlayFrets.forEach(fretNum => {
                if (fretNum <= NUM_FRETS) {
                    const x = fretNum * FRET_SPACING - (FRET_SPACING / 2); // Centrado entre trastes
                    // Puntos individuales
                    if (fretNum !== 12 && fretNum !== 24) {
                        const dot = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                        dot.setAttribute("cx", x);
                        dot.setAttribute("cy", FRETBOARD_HEIGHT / 2); // Centro del diapasón
                        dot.setAttribute("r", 5);
                        dot.setAttribute("fill", "#a0aec0"); // Color del punto (gris)
                        fretboardSvg.appendChild(dot);
                    } else {
                        // Puntos dobles para los trastes 12 y 24
                        const dot1 = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                        dot1.setAttribute("cx", x);
                        dot1.setAttribute("cy", FRETBOARD_HEIGHT / 2 - STRING_SPACING * 1.5);
                        dot1.setAttribute("r", 5);
                        dot1.setAttribute("fill", "#a0aec0");
                        fretboardSvg.appendChild(dot1);

                        const dot2 = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                        dot2.setAttribute("cx", x);
                        dot2.setAttribute("cy", FRETBOARD_HEIGHT / 2 + STRING_SPACING * 1.5);
                        dot2.setAttribute("r", 5);
                        dot2.setAttribute("fill", "#a0aec0");
                        fretboardSvg.appendChild(dot2);
                    }
                }
            });

            // Agrega los números de los trastes en la parte inferior
            for (let i = 1; i <= NUM_FRETS; i++) {
                const x = i * FRET_SPACING - (FRET_SPACING / 2); // Centrado en el traste
                const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                text.setAttribute("x", x);
                text.setAttribute("y", FRETBOARD_HEIGHT - 10); // Posición Y en la parte inferior
                text.setAttribute("text-anchor", "middle");
                text.setAttribute("fill", "#e2e8f0"); // Color del texto
                text.setAttribute("font-size", "12px");
                text.textContent = i;
                fretboardSvg.appendChild(text);
            }

            // Resalta las notas de la escala en el diapasón
            if (scaleNotesWithIntervals.length > 0 && rootNoteForFretboard) {
                let positionStartFret = 0; // The absolute starting fret of the pattern on the fretboard
                let positionEndFret = NUM_FRETS; // The absolute ending fret of the pattern on the fretboard

                const selectedPositionData = scalePositionPatterns[currentFretboardPosition];

                if (selectedPositionData) {
                    // Determine the minor root note for calculation (e.g., "Am" from "A" major + Eólico)
                    const minorRootBaseNote = rootNoteForFretboard.replace('m', ''); // "A" from "Am"
                    const minorRootMidi = getMidiNoteNumber(minorRootBaseNote, 3); // Use a consistent octave for calculation

                    // Calculate the absolute fret where the minor root is on its designated string (e.g., A on 6th string)
                    const targetRootStringIndex = selectedPositionData.rootStringIndex;
                    const openStringMidi = getMidiNoteNumber(openStringNotes[targetRootStringIndex].name.toUpperCase(), openStringNotes[targetRootStringIndex].octave);

                    // This is the absolute fret where the minor root (e.g., A) is on its designated string (e.g., 6th string)
                    let absoluteRootFretOnTargetString = minorRootMidi - openStringMidi;

                    // Adjust for octave wrapping to find the closest fret on the target string (e.g., E string has A at fret 5, 17)
                    while (absoluteRootFretOnTargetString < 0) {
                        absoluteRootFretOnTargetString += 12;
                    }
                    while (absoluteRootFretOnTargetString > 11 && absoluteRootFretOnTargetString - 12 >= 0) {
                        absoluteRootFretOnTargetString -= 12; // Keep it within the first 12 frets for consistent calculation
                    }
                    
                    // Calculate the starting fret of the entire pattern/box
                    // This shifts the whole pattern based on the target root note
                    positionStartFret = absoluteRootFretOnTargetString - selectedPositionData.rootFretInPattern;

                    // Ensure the calculated start fret is not negative (shift up an octave if needed)
                    while (positionStartFret < 0) {
                        positionStartFret += 12;
                    }

                    // Calculate the highest relative fret in the pattern to determine the box end
                    let maxRelativeFret = 0;
                    selectedPositionData.relativeFrets.forEach(stringFrets => {
                        if (stringFrets.length > 0) {
                            const maxFret = Math.max(...stringFrets);
                            if (maxFret > maxRelativeFret) {
                                maxRelativeFret = maxFret;
                            }
                        }
                    });
                    positionEndFret = positionStartFret + maxRelativeFret;

                    // Ensure the entire pattern fits within the NUM_FRETS, adjust if it goes beyond 24
                    if (positionEndFret > NUM_FRETS) {
                        positionStartFret -= (positionEndFret - NUM_FRETS);
                        if (positionStartFret < 0) positionStartFret = 0; // Don't go below fret 0
                        positionEndFret = NUM_FRETS;
                    }
                }

                scaleNotesWithIntervals.forEach((scaleNoteObj) => {
                    const targetNoteCanonical = getCanonicalNote(scaleNoteObj.note);
                    const noteFunction = classifyNoteFunction(scaleNoteObj.semitonesFromRoot); // Get function for coloring

                    const fillColor = fretboardNoteColors[noteFunction];
                    const strokeColor = darkenColor(fillColor, 20); // Slightly darker border

                    // Itera sobre cada cuerda y cada traste
                    for (let stringIdx = 0; stringIdx < NUM_STRINGS; stringIdx++) {
                        const openNoteMidi = getMidiNoteNumber(openStringNotes[stringIdx].name.toUpperCase(), openStringNotes[stringIdx].octave);
                        for (let fretNum = 0; fretNum <= NUM_FRETS; fretNum++) {
                            const currentNoteMidi = openNoteMidi + fretNum;
                            const currentNoteChromaticIndex = (currentNoteMidi - 12) % 12; // Adjust for C0=MIDI 12
                            // Obtiene el nombre de la nota en la ortografía correcta (sostenidos/bemoles)
                            const currentNoteName = getNoteNameFromChromaticIndex(currentNoteChromaticIndex, rootNoteForFretboard);
                            const currentNoteCanonical = getCanonicalNote(currentNoteName);

                            let shouldDraw = false;

                            if (currentFretboardPosition === "Full Fretboard") {
                                // For full fretboard, just check if the note is in the scale
                                if (currentNoteCanonical === targetNoteCanonical) {
                                    shouldDraw = true;
                                }
                            } else if (selectedPositionData) {
                                // For a specific position, check if the note is within the calculated box AND part of the shape
                                if (fretNum >= positionStartFret && fretNum <= positionEndFret) {
                                    const relativeFretInPattern = fretNum - positionStartFret;
                                    if (selectedPositionData.relativeFrets[stringIdx] && selectedPositionData.relativeFrets[stringIdx].includes(relativeFretInPattern)) {
                                        if (currentNoteCanonical === targetNoteCanonical) {
                                            shouldDraw = true;
                                        }
                                    }
                                }
                            }

                            if (shouldDraw) {
                                const x = fretNum * FRET_SPACING - (FRET_SPACING / 2); // Centrado en el traste
                                const y = (stringIdx + 1) * STRING_SPACING; // Centrado en la cuerda

                                const noteDot = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                                noteDot.setAttribute("cx", x);
                                noteDot.setAttribute("cy", y);
                                noteDot.setAttribute("r", noteFunction === "fundamental" ? 10 : 8); // Más grande para la tónica
                                noteDot.setAttribute("fill", fillColor);
                                noteDot.setAttribute("stroke", strokeColor);
                                noteDot.setAttribute("stroke-width", 2);
                                fretboardSvg.appendChild(noteDot);

                                const noteText = document.createElementNS("http://www.w3.org/2000/svg", "text");
                                noteText.setAttribute("x", x);
                                noteText.setAttribute("y", y + 4); // Ajuste vertical para centrar el texto
                                noteText.setAttribute("text-anchor", "middle");
                                noteText.setAttribute("fill", "#1a202c"); // Texto oscuro para contraste
                                noteText.setAttribute("font-size", noteFunction === "fundamental" ? "10px" : "9px");
                                noteText.setAttribute("font-weight", "bold");
                                noteText.textContent = scaleNoteObj.note; // Muestra el nombre de la nota de la escala
                                fretboardSvg.appendChild(noteText);
                            }
                        }
                    }
                });
            }
            console.log("Fretboard drawn.");
        }

        // Helper function to darken a hex color (simple version)
        function darkenColor(hex, percent) {
            const f=parseInt(hex.slice(1),16),t=percent<0?0:255,p=percent<0?percent*-1:percent,R=f>>16,G=(f>>8)&0x00FF,B=(f&0x0000FF);
            return "#"+(0x1000000+(Math.round((t-R)*p)+R)*0x10000+(Math.round((t-G)*p)+G)*0x100+(Math.round((t-B)*p)+B)).toString(16).slice(1);
        }


        // Key Signatures (simplification: only for C major/A minor, G major/E minor, F major/D minor)
        const keySignatures = staticMusicalData.armaduras_clave;

        // Function to draw a miniature key signature around the circle
        // (This function is only for the circle of fifths visual, not for the composition staff)
        // No need to remove it, as it's not used in the composition section's staff anymore.

        // Function to draw only the melody tablature
        function drawMelodyTablature(notes = []) {
            console.log("drawMelodyTablature called with notes:", notes);
            const tabSvg = document.getElementById("melody-tablature-svg");
            tabSvg.innerHTML = ''; // Clear any previous drawing

            const tabWidth = 800;
            const tabHeight = 150; // Adjusted height for tablature only
            const tabStartY = 20; // Initial Y position for tablature
            const tabLineSpacing = 15;

            // Set viewBox for responsive scaling
            tabSvg.setAttribute("viewBox", `0 0 ${tabWidth} ${tabHeight}`);

            // Display tuning
            const tuningText = document.createElementNS("http://www.w3.org/2000/svg", "text");
            tuningText.setAttribute("x", 20);
            tuningText.setAttribute("y", tabStartY - 5);
            tuningText.setAttribute("fill", "#a0aec0");
            tuningText.setAttribute("font-size", "14px");
            tuningText.textContent = `Afinación: EADGBe (6ª a 1ª cuerda)`;
            tabSvg.appendChild(tuningText);

            const tablatureString = generateTablatureString(notes); // Pass melody notes
            const tabLines = tablatureString.split('\n');

            tabLines.forEach((line, index) => {
                const y = tabStartY + 15 + (index * tabLineSpacing); // Adjust Y to avoid overlapping tuning text
                const tabText = document.createElementNS("http://www.w3.org/2000/svg", "text");
                tabText.setAttribute("x", 20);
                tabText.setAttribute("y", y);
                tabText.setAttribute("class", "tablature-text");
                tabText.textContent = line;
                tabSvg.appendChild(tabText);
            });
            console.log("Melody tablature drawn.");
        }

        // Chord diagram templates (fingers are absolute frets, or relative to barre fret for barre shapes)
        // rootString and rootFret/rootFretOffset are for finding the chord on the fretboard for transposition
        const chordDiagramTemplates = {
            "C": [
                { fingers: { 6: -1, 5: 3, 4: 2, 3: 0, 2: 1, 1: 0 }, mutedStrings: [6], lowestFret: 0, name: "C (Abierto)" },
                { fingers: { 6: 8, 5: 10, 4: 10, 3: 9, 2: 8, 1: 8 }, barre: { fret: 8, startString: 1, endString: 6 }, lowestFret: 8, name: "C (Cejilla E-forma)" },
                { fingers: { 6: -1, 5: 3, 4: 5, 3: 5, 2: 5, 1: 3 }, mutedStrings: [6], barre: { fret: 3, startString: 1, endString: 5 }, lowestFret: 3, name: "C (Cejilla A-forma)" }
            ],
            "Cmaj7": [
                { fingers: { 6: -1, 5: 3, 4: 2, 3: 0, 2: 0, 1: 0 }, mutedStrings: [6], lowestFret: 0, name: "Cmaj7 (Abierto)" },
                { fingers: { 6: 8, 5: 10, 4: 9, 3: 9, 2: 8, 1: 8 }, barre: { fret: 8, startString: 1, endString: 6 }, lowestFret: 8, name: "Cmaj7 (Cejilla E-forma)" }
            ],
            "Cm": [
                { fingers: { 6: -1, 5: 3, 4: 5, 3: 5, 2: 4, 1: 3 }, mutedStrings: [6], barre: { fret: 3, startString: 1, endString: 5 }, lowestFret: 3, name: "Cm (Cejilla A-forma)" },
                { fingers: { 6: 8, 5: 10, 4: 10, 3: 8, 2: 8, 1: 8 }, barre: { fret: 8, startString: 1, endString: 6 }, lowestFret: 8, name: "Cm (Cejilla E-forma)" }
            ],
            "Cm7": [
                { fingers: { 6: -1, 5: 3, 4: 5, 3: 3, 2: 4, 1: 3 }, mutedStrings: [6], lowestFret: 3, name: "Cm7 (Cejilla A-forma)" },
                { fingers: { 6: 8, 5: 10, 4: 8, 3: 8, 2: 8, 1: 8 }, barre: { fret: 8, startString: 1, endString: 6 }, lowestFret: 8, name: "Cm7 (Cejilla E-forma)" }
            ],
            "C7": [
                { fingers: { 6: -1, 5: 3, 4: 2, 3: 3, 2: 1, 1: 0 }, mutedStrings: [6], lowestFret: 0, name: "C7 (Abierto)" },
                { fingers: { 6: 8, 5: 10, 4: 8, 3: 9, 2: 8, 1: 8 }, barre: { fret: 8, startString: 1, endString: 6 }, lowestFret: 8, name: "C7 (Cejilla E-forma)" }
            ],
            "Csus4": [
                { fingers: { 6: -1, 5: 3, 4: 3, 3: 0, 2: 1, 1: 0 }, mutedStrings: [6], lowestFret: 0, name: "Csus4 (Abierto)" }
            ],
            "Cadd9": [
                { fingers: { 6: -1, 5: 3, 4: 2, 3: 0, 2: 3, 1: 0 }, mutedStrings: [6], lowestFret: 0, name: "Cadd9 (Abierto)" }
            ],
            "Cdim7": [
                { fingers: { 6: -1, 5: 3, 4: 4, 3: 2, 2: 4, 1: 2 }, mutedStrings: [6], lowestFret: 2, name: "Cdim7 (Cejilla)" }
            ],
            "Cm7b5": [
                { fingers: { 6: -1, 5: 3, 4: 4, 3: 3, 2: 4, 1: 3 }, mutedStrings: [6], lowestFret: 3, name: "Cm7b5 (Cejilla)" }
            ],

            "G": [
                { fingers: { 6: 3, 5: 2, 4: 0, 3: 0, 2: 0, 1: 3 }, lowestFret: 0, name: "G (Abierto)" },
                { fingers: { 6: 3, 5: 5, 4: 5, 3: 4, 2: 3, 1: 3 }, barre: { fret: 3, startString: 1, endString: 6 }, lowestFret: 3, name: "G (Cejilla E-forma)" },
                { fingers: { 6: -1, 5: 10, 4: 12, 3: 12, 2: 12, 1: 10 }, mutedStrings: [6], barre: { fret: 10, startString: 1, endString: 5 }, lowestFret: 10, name: "G (Cejilla A-forma)" }
            ],
            "Gmaj7": [
                { fingers: { 6: 3, 5: 2, 4: 0, 3: 0, 2: 0, 1: 2 }, lowestFret: 0, name: "Gmaj7 (Abierto)" },
                { fingers: { 6: 3, 5: 5, 4: 4, 3: 4, 2: 3, 1: 3 }, barre: { fret: 3, startString: 1, endString: 6 }, lowestFret: 3, name: "Gmaj7 (Cejilla E-forma)" }
            ],
            "Gm": [
                { fingers: { 6: 3, 5: 5, 4: 5, 3: 3, 2: 3, 1: 3 }, barre: { fret: 3, startString: 1, endString: 6 }, lowestFret: 3, name: "Gm (Cejilla E-forma)" },
                { fingers: { 6: -1, 5: 10, 4: 12, 3: 12, 2: 11, 1: 10 }, mutedStrings: [6], barre: { fret: 10, startString: 1, endString: 5 }, lowestFret: 10, name: "Gm (Cejilla A-forma)" }
            ],
            "Gm7": [
                { fingers: { 6: 3, 5: 5, 4: 3, 3: 3, 2: 3, 1: 3 }, barre: { fret: 3, startString: 1, endString: 6 }, lowestFret: 3, name: "Gm7 (Cejilla E-forma)" },
                { fingers: { 6: -1, 5: 10, 4: 12, 3: 10, 2: 11, 1: 10 }, mutedStrings: [6], barre: { fret: 10, startString: 1, endString: 5 }, lowestFret: 10, name: "Gm7 (Cejilla A-forma)" }
            ],
            "G7": [
                { fingers: { 6: 3, 5: 2, 4: 0, 3: 0, 2: 0, 1: 1 }, lowestFret: 0, name: "G7 (Abierto)" },
                { fingers: { 6: 3, 5: 5, 4: 3, 3: 4, 2: 3, 1: 3 }, barre: { fret: 3, startString: 1, endString: 6 }, lowestFret: 3, name: "G7 (Cejilla E-forma)" }
            ],
            "Gsus4": [
                { fingers: { 6: 3, 5: 3, 4: 0, 3: 0, 2: 0, 1: 3 }, lowestFret: 0, name: "Gsus4 (Abierto)" }
            ],
            "Gadd9": [
                { fingers: { 6: 3, 5: 2, 4: 0, 3: 2, 2: 0, 1: 3 }, lowestFret: 0, name: "Gadd9 (Abierto)" }
            ],
            "Gdim7": [
                { fingers: { 6: -1, 5: 4, 4: 5, 3: 3, 2: 5, 1: 3 }, mutedStrings: [6], lowestFret: 3, name: "Gdim7 (Cejilla)" }
            ],
            "Gm7b5": [
                { fingers: { 6: -1, 5: 4, 4: 5, 3: 4, 2: 5, 1: 4 }, mutedStrings: [6], lowestFret: 4, name: "Gm7b5 (Cejilla)" }
            ],
            "B": [
                { fingers: { 6: 1, 5: 3, 4: 3, 3: 2, 2: 1, 1: 1 }, barre: { fret: 7, startString: 1, endString: 6 }, lowestFret: 7, name: "B (Cejilla E-forma)" },
                { fingers: { 6: -1, 5: 2, 4: 4, 3: 4, 2: 4, 1: 2 }, barre: { fret: 2, startString: 1, endString: 5 }, lowestFret: 2, name: "B (Cejilla A-forma)" }
            ],
            "Bm": [
                { fingers: { 6: 1, 5: 3, 4: 3, 3: 1, 2: 1, 1: 1 }, barre: { fret: 7, startString: 1, endString: 6 }, lowestFret: 7, name: "Bm (Cejilla E-forma)" },
                { fingers: { 6: -1, 5: 2, 4: 4, 3: 4, 2: 3, 1: 2 }, barre: { fret: 2, startString: 1, endString: 5 }, lowestFret: 2, name: "Bm (Cejilla A-forma)" }
            ],
            "Bm7": [
                { fingers: { 6: 1, 5: 3, 4: 1, 3: 1, 2: 1, 1: 1 }, barre: { fret: 7, startString: 1, endString: 6 }, lowestFret: 7, name: "Bm7 (Cejilla E-forma)" },
                { fingers: { 6: -1, 5: 2, 4: 4, 3: 2, 2: 3, 1: 2 }, mutedStrings: [6], barre: { fret: 2, startString: 1, endString: 5 }, lowestFret: 2, name: "Bm7 (Cejilla A-forma)" }
            ],
            "B7": [
                { fingers: { 6: 1, 5: 3, 4: 1, 3: 2, 2: 1, 1: 1 }, barre: { fret: 7, startString: 1, endString: 6 }, lowestFret: 7, name: "B7 (Cejilla E-forma)" },
                { fingers: { 6: -1, 5: 2, 4: 4, 3: 2, 2: 4, 1: 2 }, mutedStrings: [6], barre: { fret: 2, startString: 1, endString: 5 }, lowestFret: 2, name: "B7 (Cejilla A-forma)" }
            ],
            "Bsus4": [
                { fingers: { 6: 1, 5: 3, 4: 3, 3: 3, 2: 1, 1: 1 }, barre: { fret: 7, startString: 1, endString: 6 }, lowestFret: 7, name: "Bsus4 (Cejilla E-forma)" }
            ],
            "Badd9": [
                { fingers: { 6: 1, 5: 3, 4: 3, 3: 2, 2: 4, 1: 1 }, barre: { fret: 7, startString: 1, endString: 6 }, lowestFret: 7, name: "Badd9 (Cejilla E-forma)" }
            ],
            "Bdim7": [
                { fingers: { 6: 1, 5: 2, 4: 3, 3: 1, 2: 3, 1: 2 }, lowestFret: 7, name: "Bdim7 (Cejilla)" }
            ],
            "Bm7b5": [
                { fingers: { 6: 1, 5: 2, 4: 3, 3: 1, 2: 3, 1: 2 }, lowestFret: 7, name: "Bm7b5 (Cejilla)" }
            ]

            "D": [
                { fingers: { 6: -1, 5: -1, 4: 0, 3: 2, 2: 3, 1: 2 }, mutedStrings: [6, 5], lowestFret: 0, name: "D (Abierto)" },
                { fingers: { 6: 10, 5: 12, 4: 12, 3: 11, 2: 10, 1: 10 }, barre: { fret: 10, startString: 1, endString: 6 }, lowestFret: 10, name: "D (Cejilla E-forma)" },
                { fingers: { 6: -1, 5: 5, 4: 7, 3: 7, 2: 7, 1: 5 }, mutedStrings: [6], barre: { fret: 5, startString: 1, endString: 5 }, lowestFret: 5, name: "D (Cejilla A-forma)" }
            ],
            "Dmaj7": [
                { fingers: { 6: -1, 5: -1, 4: 0, 3: 2, 2: 2, 1: 2 }, mutedStrings: [6, 5], lowestFret: 0, name: "Dmaj7 (Abierto)" },
                { fingers: { 6: 10, 5: 12, 4: 11, 3: 11, 2: 10, 1: 10 }, barre: { fret: 10, startString: 1, endString: 6 }, lowestFret: 10, name: "Dmaj7 (Cejilla E-forma)" }
            ],
            "Dm": [
                { fingers: { 6: -1, 5: -1, 4: 0, 3: 2, 2: 3, 1: 1 }, mutedStrings: [6, 5], lowestFret: 0, name: "Dm (Abierto)" },
                { fingers: { 6: 10, 5: 12, 4: 12, 3: 10, 2: 10, 1: 10 }, barre: { fret: 10, startString: 1, endString: 6 }, lowestFret: 10, name: "Dm (Cejilla E-forma)" },
                { fingers: { 6: -1, 5: 5, 4: 7, 3: 7, 2: 6, 1: 5 }, mutedStrings: [6], barre: { fret: 5, startString: 1, endString: 5 }, lowestFret: 5, name: "Dm (Cejilla A-forma)" }
            ],
            "Dm7": [
                { fingers: { 6: -1, 5: -1, 4: 0, 3: 2, 2: 1, 1: 1 }, mutedStrings: [6, 5], lowestFret: 0, name: "Dm7 (Abierto)" },
                { fingers: { 6: 10, 5: 12, 4: 10, 3: 10, 2: 10, 1: 10 }, barre: { fret: 10, startString: 1, endString: 6 }, lowestFret: 10, name: "Dm7 (Cejilla E-forma)" },
                { fingers: { 6: -1, 5: 5, 4: 7, 3: 5, 2: 6, 1: 5 }, mutedStrings: [6], barre: { fret: 5, startString: 1, endString: 5 }, lowestFret: 5, name: "Dm7 (Cejilla A-forma)" }
            ],
            "D7": [
                { fingers: { 6: -1, 5: -1, 4: 0, 3: 2, 2: 1, 1: 2 }, mutedStrings: [6, 5], lowestFret: 0, name: "D7 (Abierto)" },
                { fingers: { 6: 10, 5: 12, 4: 10, 3: 11, 2: 10, 1: 10 }, barre: { fret: 10, startString: 1, endString: 6 }, lowestFret: 10, name: "D7 (Cejilla E-forma)" }
            ],
            "Dsus4": [
                { fingers: { 6: -1, 5: -1, 4: 0, 3: 2, 2: 3, 1: 3 }, mutedStrings: [6, 5], lowestFret: 0, name: "Dsus4 (Abierto)" }
            ],
            "Dadd9": [
                { fingers: { 6: -1, 5: -1, 4: 0, 3: 2, 2: 3, 1: 0 }, mutedStrings: [6, 5], lowestFret: 0, name: "Dadd9 (Abierto)" }
            ],
            "Ddim7": [
                { fingers: { 6: -1, 5: -1, 4: 1, 3: 2, 2: 1, 1: 2 }, mutedStrings: [6, 5], lowestFret: 1, name: "Ddim7 (Abierto)" }
            ],
            "Dm7b5": [
                { fingers: { 6: -1, 5: -1, 4: 1, 3: 3, 2: 1, 1: 2 }, mutedStrings: [6, 5], lowestFret: 1, name: "Dm7b5 (Abierto)" }
            ],

            "A": [
                { fingers: { 6: -1, 5: 0, 4: 2, 3: 2, 2: 2, 1: 0 }, mutedStrings: [6], lowestFret: 0, name: "A (Abierto)" },
                { fingers: { 6: 5, 5: 7, 4: 7, 3: 6, 2: 5, 1: 5 }, barre: { fret: 5, startString: 1, endString: 6 }, lowestFret: 5, name: "A (Cejilla E-forma)" },
                { fingers: { 6: -1, 5: 0, 4: 0, 3: 2, 2: 2, 1: 0 }, mutedStrings: [6], lowestFret: 0, name: "A (Abierto 2)" }
            ],
            "Amaj7": [
                { fingers: { 6: -1, 5: 0, 4: 2, 3: 1, 2: 2, 1: 0 }, mutedStrings: [6], lowestFret: 0, name: "Amaj7 (Abierto)" },
                { fingers: { 6: 5, 5: 7, 4: 6, 3: 6, 2: 5, 1: 5 }, barre: { fret: 5, startString: 1, endString: 6 }, lowestFret: 5, name: "Amaj7 (Cejilla E-forma)" }
            ],
            "Am": [
                { fingers: { 6: -1, 5: 0, 4: 2, 3: 2, 2: 1, 1: 0 }, mutedStrings: [6], lowestFret: 0, name: "Am (Abierto)" },
                { fingers: { 6: 5, 5: 7, 4: 7, 3: 5, 2: 5, 1: 5 }, barre: { fret: 5, startString: 1, endString: 6 }, lowestFret: 5, name: "Am (Cejilla E-forma)" },
                { fingers: { 6: -1, 5: 0, 4: 2, 3: 0, 2: 1, 1: 0 }, mutedStrings: [6], lowestFret: 0, name: "Am (Abierto 2)" }
            ],
            "Am7": [
                { fingers: { 6: -1, 5: 0, 4: 2, 3: 0, 2: 1, 1: 0 }, mutedStrings: [6], lowestFret: 0, name: "Am7 (Abierto)" },
                { fingers: { 6: 5, 5: 7, 4: 5, 3: 5, 2: 5, 1: 5 }, barre: { fret: 5, startString: 1, endString: 6 }, lowestFret: 5, name: "Am7 (Cejilla E-forma)" }
            ],
            "A7": [
                { fingers: { 6: -1, 5: 0, 4: 2, 3: 0, 2: 2, 1: 0 }, mutedStrings: [6], lowestFret: 0, name: "A7 (Abierto)" },
                { fingers: { 6: 5, 5: 7, 4: 5, 3: 6, 2: 5, 1: 5 }, barre: { fret: 5, startString: 1, endString: 6 }, lowestFret: 5, name: "A7 (Cejilla E-forma)" }
            ],
            "Asus4": [
                { fingers: { 6: -1, 5: 0, 4: 2, 3: 2, 2: 3, 1: 0 }, mutedStrings: [6], lowestFret: 0, name: "Asus4 (Abierto)" }
            ],
            "Aadd9": [
                { fingers: { 6: -1, 5: 0, 4: 2, 3: 4, 2: 2, 1: 0 }, mutedStrings: [6], lowestFret: 0, name: "Aadd9 (Abierto)" }
            ],
            "Adim7": [
                { fingers: { 6: -1, 5: 0, 4: 1, 3: 0, 2: 1, 1: 0 }, mutedStrings: [6], lowestFret: 0, name: "Adim7 (Abierto)" }
            ],
            "Am7b5": [
                { fingers: { 6: -1, 5: 0, 4: 1, 3: 0, 2: 1, 1: 0 }, mutedStrings: [6], lowestFret: 0, name: "Am7b5 (Abierto)" }
            ],

            "E": [
                { fingers: { 6: 0, 5: 2, 4: 2, 3: 1, 2: 0, 1: 0 }, lowestFret: 0, name: "E (Abierto)" },
                { fingers: { 6: 0, 5: 2, 4: 2, 3: 1, 2: 0, 1: 0 }, lowestFret: 0, name: "E (Abierto 2)" }
            ],
            "Emaj7": [
                { fingers: { 6: 0, 5: 2, 4: 1, 3: 1, 2: 0, 1: 0 }, lowestFret: 0, name: "Emaj7 (Abierto)" }
            ],
            "Em": [
                { fingers: { 6: 0, 5: 2, 4: 2, 3: 0, 2: 0, 1: 0 }, lowestFret: 0, name: "Em (Abierto)" },
                { fingers: { 6: 0, 5: 2, 4: 2, 3: 0, 2: 0, 1: 0 }, lowestFret: 0, name: "Em (Abierto 2)" }
            ],
            "Em7": [
                { fingers: { 6: 0, 5: 2, 4: 0, 3: 0, 2: 0, 1: 0 }, lowestFret: 0, name: "Em7 (Abierto)" }
            ],
            "E7": [
                { fingers: { 6: 0, 5: 2, 4: 0, 3: 1, 2: 0, 1: 0 }, lowestFret: 0, name: "E7 (Abierto)" }
            ],
            "Esus4": [
                { fingers: { 6: 0, 5: 2, 4: 2, 3: 2, 2: 0, 1: 0 }, lowestFret: 0, name: "Esus4 (Abierto)" }
            ],
            "Eadd9": [
                { fingers: { 6: 0, 5: 2, 4: 4, 3: 1, 2: 0, 1: 0 }, lowestFret: 0, name: "Eadd9 (Abierto)" }
            ],
            "Edim7": [
                { fingers: { 6: 0, 5: 1, 4: 2, 3: 0, 2: 2, 1: 1 }, lowestFret: 0, name: "Edim7 (Abierto)" }
            ],
            "Em7b5": [
                { fingers: { 6: 0, 5: 1, 4: 2, 3: 0, 2: 2, 1: 1 }, lowestFret: 0, name: "Em7b5 (Abierto)" }
            ],

            "F": [
                { fingers: { 6: 1, 5: 3, 4: 3, 3: 2, 2: 1, 1: 1 }, barre: { fret: 1, startString: 1, endString: 6 }, lowestFret: 1, name: "F (Cejilla E-forma)" },
                { fingers: { 6: -1, 5: 8, 4: 10, 3: 10, 2: 10, 1: 8 }, mutedStrings: [6], barre: { fret: 8, startString: 1, endString: 5 }, lowestFret: 8, name: "F (Cejilla A-forma)" }
            ],
            "Fmaj7": [
                { fingers: { 6: 1, 5: 3, 4: 2, 3: 2, 2: 1, 1: 1 }, barre: { fret: 1, startString: 1, endString: 6 }, lowestFret: 1, name: "Fmaj7 (Cejilla E-forma)" },
                { fingers: { 6: -1, 5: 8, 4: 9, 3: 9, 2: 8, 1: 8 }, mutedStrings: [6], barre: { fret: 8, startString: 1, endString: 5 }, lowestFret: 8, name: "Fmaj7 (Cejilla A-forma)" }
            ],
            "Fm": [
                { fingers: { 6: 1, 5: 3, 4: 3, 3: 1, 2: 1, 1: 1 }, barre: { fret: 1, startString: 1, endString: 6 }, lowestFret: 1, name: "Fm (Cejilla E-forma)" },
                { fingers: { 6: -1, 5: 8, 4: 10, 3: 10, 2: 9, 1: 8 }, mutedStrings: [6], barre: { fret: 8, startString: 1, endString: 5 }, lowestFret: 8, name: "Fm (Cejilla A-forma)" }
            ],
            "Fm7": [
                { fingers: { 6: 1, 5: 3, 4: 1, 3: 1, 2: 1, 1: 1 }, barre: { fret: 1, startString: 1, endString: 6 }, lowestFret: 1, name: "Fm7 (Cejilla E-forma)" },
                { fingers: { 6: -1, 5: 8, 4: 10, 3: 8, 2: 9, 1: 8 }, mutedStrings: [6], barre: { fret: 8, startString: 1, endString: 5 }, lowestFret: 8, name: "Fm7 (Cejilla A-forma)" }
            ],
            "F7": [
                { fingers: { 6: 1, 5: 3, 4: 1, 3: 2, 2: 1, 1: 1 }, barre: { fret: 1, startString: 1, endString: 6 }, lowestFret: 1, name: "F7 (Cejilla E-forma)" },
                { fingers: { 6: -1, 5: 8, 4: 10, 3: 8, 2: 10, 1: 8 }, mutedStrings: [6], barre: { fret: 8, startString: 1, endString: 5 }, lowestFret: 8, name: "F7 (Cejilla A-forma)" }
            ],
            "Fsus4": [
                { fingers: { 6: 1, 5: 3, 4: 3, 3: 3, 2: 1, 1: 1 }, barre: { fret: 1, startString: 1, endString: 6 }, lowestFret: 1, name: "Fsus4 (Cejilla E-forma)" }
            ],
            "Fadd9": [
                { fingers: { 6: 1, 5: 3, 4: 3, 3: 2, 2: 4, 1: 1 }, barre: { fret: 1, startString: 1, endString: 6 }, lowestFret: 1, name: "Fadd9 (Cejilla E-forma)" }
            ],
            "Fdim7": [
                { fingers: { 6: 1, 5: 2, 4: 3, 3: 1, 2: 3, 1: 2 }, lowestFret: 1, name: "Fdim7 (Cejilla)" }
            ],
            "Fm7b5": [
                { fingers: { 6: 1, 5: 2, 4: 3, 3: 1, 2: 3, 1: 2 }, lowestFret: 1, name: "Fm7b5 (Cejilla)" }
            ],
            // ... add more chords as needed
        };

        // Function to get the full chord data (absolute frets, barre info) for drawing
        function getChordDiagramData(chordName) {
            // First, try to find an exact match in the templates
            if (chordDiagramTemplates[chordName]) {
                return chordDiagramTemplates[chordName];
            }

            // If not found, try to derive from base note and quality
            const rootNoteMatch = chordName.match(/([A-G][b#]?)/);
            if (!rootNoteMatch) {
                console.warn(`Could not parse root note from chord name: ${chordName}`);
                return null;
            }
            const rootNote = rootNoteMatch[1]; // e.g., "C", "G#", "Db"

            // Try to find templates for the base note (e.g., "C" for "Cmaj7")
            if (chordDiagramTemplates[rootNote]) {
                // Filter these templates to find the most suitable one
                // This is a simplification. A real chord library would be much more complex.
                const possibleVoicings = chordDiagramTemplates[rootNote].filter(voicing => {
                    // Simple logic: if chordName has "maj7", prefer voicings with "maj7" in their name, etc.
                    if (chordName.includes('maj7') && !voicing.name.includes('maj7')) return false;
                    if (chordName.includes('m7b5') && !voicing.name.includes('m7b5')) return false;
                    if (chordName.includes('dim7') && !voicing.name.includes('dim7')) return false;
                    if (chordName.endsWith('m7') && !voicing.name.includes('m7')) return false;
                    if (chordName.endsWith('7') && !voicing.name.includes('7') && !voicing.name.includes('maj7')) return false; // Exclude maj7 if looking for dominant 7
                    if (chordName.includes('sus4') && !voicing.name.includes('sus4')) return false;
                    if (chordName.includes('add9') && !voicing.name.includes('add9')) return false;
                    // If it's a minor chord, prefer minor voicings
                    if (chordName.includes('m') && !chordName.includes('maj') && !voicing.name.includes('m')) return false;
                    // If it's a major chord (no 'm'), prefer major voicings
                    if (!chordName.includes('m') && voicing.name.includes('m')) return false;

                    return true;
                });
                if (possibleVoicings.length > 0) {
                    return possibleVoicings; // Return all filtered voicings
                }
            }
            console.warn(`No suitable diagram template found for ${chordName}.`);
            return null;
        }

        // Function to draw a single chord diagram
        function drawChordDiagram(svgContainer, chordName, voicingData, isModal = false) {
            if (!voicingData) {
                // Fallback to a generic placeholder if no diagram data
                const placeholder = document.createElement('div');
                placeholder.textContent = chordName;
                placeholder.classList.add('p-4', 'bg-gray-600', 'rounded-md', 'text-center');
                svgContainer.appendChild(placeholder);
                return;
            }

            const diagramWidth = isModal ? 120 : 100;
            const diagramHeight = isModal ? 140 : 120;
            const numFretsVisible = 4; // Show first 4 frets relative to the lowest played fret
            const fretSpacing = (diagramWidth - 20) / (numFretsVisible + 1);
            const stringSpacing = (diagramHeight - 30) / (NUM_STRINGS - 1);

            const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.setAttribute("width", diagramWidth);
            svg.setAttribute("height", diagramHeight);
            svg.setAttribute("viewBox", `0 0 ${diagramWidth} ${diagramHeight}`);
            svg.setAttribute("class", "chord-diagram-svg");
            svg.setAttribute("data-chord-name", chordName); // Store original chord name
            svg.setAttribute("data-voicing-name", voicingData.name); // Store voicing name for selection

            // Chord Name
            const chordNameText = document.createElementNS("http://www.w3.org/2000/svg", "text");
            chordNameText.setAttribute("x", diagramWidth / 2);
            chordNameText.setAttribute("y", 15);
            chordNameText.setAttribute("text-anchor", "middle");
            chordNameText.setAttribute("fill", "#f6ad55");
            chordNameText.setAttribute("font-size", "16px");
            chordNameText.setAttribute("font-weight", "bold");
            chordNameText.textContent = voicingData.name || chordName; // Use voicing name if available
            svg.appendChild(chordNameText);

            // Determine the lowest actual fret to display (for relative drawing)
            let lowestActualFret = Infinity;
            Object.values(voicingData.fingers).forEach(fret => {
                if (fret !== -1 && fret < lowestActualFret) {
                    lowestActualFret = fret;
                }
            });
            if (lowestActualFret === Infinity) lowestActualFret = 0; // If no fretted notes, assume open/muted

            // Draw frets (horizontal lines)
            for (let i = 0; i <= numFretsVisible; i++) {
                const y = 30 + (i * fretSpacing);
                const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                line.setAttribute("x1", 10);
                line.setAttribute("y1", y);
                line.setAttribute("x2", diagramWidth - 10);
                line.setAttribute("y2", y);
                line.setAttribute("class", "fret-line");
                svg.appendChild(line);
            }

            // Draw strings (vertical lines)
            for (let i = 0; i < NUM_STRINGS; i++) {
                const x = 10 + (i * stringSpacing);
                const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                line.setAttribute("x1", x);
                line.setAttribute("y1", 30);
                line.setAttribute("x2", x);
                line.setAttribute("y2", diagramHeight - 10);
                line.setAttribute("class", "string-line");
                svg.appendChild(line);
            }

            // Draw nut (thicker line at the top) if lowest played fret is 0 and no barre
            if (lowestActualFret === 0 && (!voicingData.barre || voicingData.barre.fret !== 0)) {
                const nut = document.createElementNS("http://www.w3.org/2000/svg", "line");
                nut.setAttribute("x1", 10);
                nut.setAttribute("y1", 30);
                nut.setAttribute("x2", diagramWidth - 10);
                nut.setAttribute("y2", 30);
                nut.setAttribute("class", "nut-line");
                svg.appendChild(nut);
            }

            // Draw barre if exists and starts at a fret > 0
            if (voicingData.barre && voicingData.barre.fret > 0) {
                const barreFret = voicingData.barre.fret;
                const barreY = 30 + ((barreFret - lowestActualFret) * fretSpacing) + (fretSpacing / 2) - 10;
                const barreX1 = 10 + ((voicingData.barre.startString - 1) * stringSpacing);
                const barreX2 = 10 + ((voicingData.barre.endString - 1) * stringSpacing); // Corrected end string calculation

                const barreRect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                barreRect.setAttribute("x", barreX1);
                barreRect.setAttribute("y", barreY);
                barreRect.setAttribute("width", barreX2 - barreX1);
                barreRect.setAttribute("height", 20); // Thickness of the barre
                barreRect.setAttribute("rx", 5); // Rounded corners
                barreRect.setAttribute("ry", 5);
                barreRect.setAttribute("fill", "#f6ad55"); // Orange color for barre
                svg.appendChild(barreRect);

                // Add fret number for the barre
                const barreFretText = document.createElementNS("http://www.w3.org/2000/svg", "text");
                barreFretText.setAttribute("x", barreX1 + (barreX2 - barreX1) / 2);
                barreFretText.setAttribute("y", barreY + 14); // Vertically center text
                barreFretText.setAttribute("text-anchor", "middle");
                barreFretText.setAttribute("fill", "#1a202c"); // Dark text on orange
                barreFretText.setAttribute("font-size", "10px");
                barreFretText.setAttribute("font-weight", "bold");
                barreFretText.textContent = barreFret;
                svg.appendChild(barreFretText);
            }


            // Draw finger dots, open string markers, muted string markers
            for (let stringIdx = 0; stringIdx < NUM_STRINGS; stringIdx++) {
                const fret = voicingData.fingers[stringIdx + 1]; // stringIdx is 0-5, fingers are 1-6
                const x = 10 + (stringIdx * stringSpacing);

                if (fret === 0) {
                    // Open string
                    const openMarker = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                    openMarker.setAttribute("cx", x);
                    openMarker.setAttribute("cy", 25); // Above the nut
                    openMarker.setAttribute("r", 4);
                    openMarker.setAttribute("class", "open-string-marker");
                    svg.appendChild(openMarker);
                } else if (voicingData.mutedStrings && voicingData.mutedStrings.includes(stringIdx + 1)) { // Check mutedStrings array (1-indexed)
                    // Muted string (X)
                    const mutedX = document.createElementNS("http://www.w3.org/2000/svg", "text");
                    mutedX.setAttribute("x", x);
                    mutedX.setAttribute("y", 28); // Above the nut
                    mutedX.setAttribute("text-anchor", "middle");
                    mutedX.setAttribute("class", "muted-string-marker");
                    mutedX.textContent = "X";
                    svg.appendChild(mutedX);
                } else if (fret > 0 && !(voicingData.barre && fret === voicingData.barre.fret && stringIdx + 1 >= voicingData.barre.startString && stringIdx + 1 <= voicingData.barre.endString)) {
                    // Fretted note (and not covered by a drawn barre)
                    const y = 30 + ((fret - lowestActualFret) * fretSpacing) + (fretSpacing / 2); // Center in the fret
                    const fingerDot = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                    fingerDot.setAttribute("cx", x);
                    fingerDot.setAttribute("cy", y);
                    fingerDot.setAttribute("r", 7);
                    fingerDot.setAttribute("class", "finger-dot");
                    svg.appendChild(fingerDot);

                    // Add fret number on the dot
                    const fretText = document.createElementNS("http://www.w3.org/2000/svg", "text");
                    fretText.setAttribute("x", x);
                    fretText.setAttribute("y", y + 4); // Adjust for vertical centering
                    fretText.setAttribute("text-anchor", "middle");
                    fretText.setAttribute("fill", "#1a202c"); // Dark text on orange dot
                    fretText.setAttribute("font-size", "10px");
                    fretText.setAttribute("font-weight", "bold");
                    fretText.textContent = fret;
                    svg.appendChild(fretText);
                }
            }

            svgContainer.appendChild(svg);
        }

        // Function to draw strumming pattern
        function drawStrummingPattern(containerId, complexity) {
            const container = document.getElementById(containerId);
            container.innerHTML = ''; // Clear previous content

            const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.setAttribute("width", "100%");
            svg.setAttribute("height", "80");
            svg.setAttribute("viewBox", "0 0 400 80");
            svg.setAttribute("class", "strum-pattern-svg");

            const strumPatterns = {
                "facil": [
                    [{ type: "down", beat: "1" }, { type: "down", beat: "2" }, { type: "down", beat: "3" }, { type: "down", beat: "4" }],
                    [{ type: "down", beat: "1" }, { type: "rest", beat: "X" }, { type: "down", beat: "2" }, { type: "rest", beat: "X" }, { type: "down", beat: "3" }, { type: "rest", beat: "X" }, { type: "down", beat: "4" }, { type: "rest", beat: "X" }]
                ],
                "intermedio": [
                    [{ type: "down", beat: "1" }, { type: "up", beat: "&" }, { type: "down", beat: "2" }, { type: "up", beat: "&" }, { type: "down", beat: "3" }, { type: "up", beat: "&" }, { type: "down", beat: "4" }, { type: "up", beat: "&" }],
                    [{ type: "down", beat: "1" }, { type: "rest", beat: "X" }, { type: "down", beat: "2" }, { type: "up", beat: "&" }, { type: "down", beat: "3" }, { type: "rest", beat: "X" }, { type: "up", beat: "&" }, { type: "down", beat: "4" }]
                ],
                "avanzado": [
                    [{ type: "down", beat: "1" }, { type: "up", beat: "e" }, { type: "down", beat: "&" }, { type: "up", beat: "a" }, { type: "down", beat: "2" }, { type: "up", beat: "e" }, { type: "down", beat: "&" }, { type: "up", beat: "a" }], // 16th notes
                    [{ type: "down", beat: "1" }, { type: "down", beat: " " }, { type: "up", beat: "&" }, { type: "down", beat: "2" }, { type: "down", beat: " " }, { type: "up", beat: "&" }, { type: "down", beat: "3" }, { type: "down", beat: " " }, { type: "up", beat: "&" }, { type: "down", beat: "4" }] // Syncopated
                ]
            };

            const selectedPattern = strumPatterns[complexity][Math.floor(Math.random() * strumPatterns[complexity].length)];

            const startX = 30;
            const spacing = 45;
            const arrowY = 30;
            const beatTextY = 60;

            selectedPattern.forEach((strum, index) => {
                const x = startX + (index * spacing);

                if (strum.type === "down") {
                    const pathD = `M ${x} ${arrowY - 15} L ${x - 8} ${arrowY} L ${x + 8} ${arrowY} Z M ${x} ${arrowY} V ${arrowY + 20}`;
                    const arrowPath = document.createElementNS("http://www.w3.org/2000/svg", "path");
                    arrowPath.setAttribute("d", pathD);
                    arrowPath.setAttribute("class", "strum-arrow");
                    svg.appendChild(arrowPath);
                } else if (strum.type === "up") {
                    const pathD = `M ${x} ${arrowY + 20 + 15} L ${x - 8} ${arrowY + 20} L ${x + 8} ${arrowY + 20} Z M ${x} ${arrowY} V ${arrowY + 20}`;
                    const arrowPath = document.createElementNS("http://www.w3.org/2000/svg", "path");
                    arrowPath.setAttribute("d", pathD);
                    arrowPath.setAttribute("class", "strum-arrow");
                    svg.appendChild(arrowPath);
                } else if (strum.type === "rest") {
                    const restSymbol = document.createElementNS("http://www.w3.org/2000/svg", "text");
                    restSymbol.setAttribute("x", x);
                    restSymbol.setAttribute("y", arrowY + 10);
                    restSymbol.setAttribute("text-anchor", "middle");
                    restSymbol.setAttribute("class", "strum-rest-symbol");
                    restSymbol.textContent = strum.beat; // Can be 'X' or ' '
                    svg.appendChild(restSymbol);
                }

                // Draw beat text
                const beatText = document.createElementNS("http://www.w3.org/2000/svg", "text");
                beatText.setAttribute("x", x);
                beatText.setAttribute("y", beatTextY);
                beatText.setAttribute("text-anchor", "middle");
                beatText.setAttribute("class", "strum-beat-text");
                beatText.textContent = strum.beat;
                svg.appendChild(beatText);
            });

            container.appendChild(svg);
        }

        // Function to get the diatonic chords for a given major key
        function getDiatonicChordsForMajorKey(majorKey) {
            const scaleNotes = getModeNotesWithIntervals(majorKey, "Jónico (Mayor)").map(n => n.note);
            // Qualities for I, ii, iii, IV, V, vi, vii°
            // Major, minor, minor, Major, Major, minor, diminished
            const diatonicQualities = ["", "m", "m", "", "", "m", "°"];

            const chords = {};
            for (let i = 0; i < scaleNotes.length; i++) {
                const romanNumeral = ["I", "ii", "iii", "IV", "V", "vi", "vii°"][i];
                const chordRoot = scaleNotes[i];
                chords[romanNumeral] = chordRoot + diatonicQualities[i];
            }
            return chords;
        }

        // Function to get the diatonic chords for a given minor key
        function getDiatonicChordsForMinorKey(minorKeyRoot) {
            const scaleNotes = getModeNotesWithIntervals(minorKeyRoot, "Eólico (Menor)").map(n => n.note);
            // Qualities for i, ii°, III, iv, v, VI, VII (natural minor)
            // minor, diminished, Major, minor, minor, Major, Major
            const diatonicQualities = ["m", "°", "", "m", "m", "", ""];

            const chords = {};
            for (let i = 0; i < scaleNotes.length; i++) {
                const romanNumeral = ["i", "ii°", "III", "iv", "v", "VI", "VII"][i];
                const chordRoot = scaleNotes[i];
                chords[romanNumeral] = chordRoot + diatonicQualities[i];
            }
            return chords;
        }

        // NEW: Function to get the type of diatonic chord for each note in a major key
        function getDiatonicChordTypesForMajorKey(majorKey) {
            const scaleNotesWithIntervals = getModeNotesWithIntervals(majorKey, "Jónico (Mayor)");
            const diatonicChordTypes = {};

            // Qualities for I, ii, iii, IV, V, vi, vii°
            const qualities = ["Major", "minor", "minor", "Major", "Major", "minor", "diminished"];

            scaleNotesWithIntervals.forEach((noteObj, index) => {
                const chordRoot = noteObj.note;
                const chordQuality = qualities[index];
                diatonicChordTypes[getCanonicalNote(chordRoot)] = chordQuality;
            });
            return diatonicChordTypes;
        }


        // Función para resaltar los 7 acordes diatónicos de la tonalidad en el Círculo de Quintas
        function highlightCircleNotes(selectedNoteValue, selectedNoteType) {
            console.log("highlightCircleNotes called with:", selectedNoteValue, selectedNoteType);

            // Determina la tonalidad mayor raíz
            let actualRootMajorNote;
            if (selectedNoteType === "major") {
                actualRootMajorNote = selectedNoteValue;
            } else { // selectedNoteType === "minor"
                actualRootMajorNote = relativeMajors[selectedNoteValue];
            }

            // Quita cualquier resaltado existente de todas las notas del círculo
            document.querySelectorAll(".note-group").forEach(group => {
                group.classList.remove("highlighted-tonic-major");
                group.classList.remove("highlighted-other-major-diatonic");
                group.classList.remove("highlighted-other-minor-diatonic");
                group.classList.remove("highlighted-diminished-diatonic");
            });

            const diatonicChordTypes = getDiatonicChordTypesForMajorKey(actualRootMajorNote);
            const relativeMinorNote = relativeMinors[actualRootMajorNote]; // Still useful for logic, but not a distinct color

            // Loop through all note groups and apply the correct highlight
            document.querySelectorAll(".note-group").forEach(group => {
                const groupNoteValue = group.dataset.noteValue;
                const canonicalGroupNote = getCanonicalNote(groupNoteValue);

                if (canonicalGroupNote === getCanonicalNote(actualRootMajorNote)) {
                    group.classList.add("highlighted-tonic-major");
                } else if (diatonicChordTypes[canonicalGroupNote]) {
                    const chordQuality = diatonicChordTypes[canonicalGroupNote];
                    if (chordQuality === "Major") {
                        group.classList.add("highlighted-other-major-diatonic");
                    } else if (chordQuality === "minor") {
                        group.classList.add("highlighted-other-minor-diatonic"); // This now includes 'vi'
                    } else if (chordQuality === "diminished") {
                        group.classList.add("highlighted-diminished-diatonic");
                    }
                }
            });


            // Actualiza la información en la pantalla (título y notas de la escala mayor)
            document.getElementById("selected-key-title").textContent = `Tonalidad Seleccionada: ${actualRootMajorNote} Mayor (${relativeMinors[actualRootMajorNote]} menor)`;
            let detailedNotesHtml = getModeNotesWithIntervals(actualRootMajorNote, "Jónico (Mayor)").map(n =>
                `<span class="${n.semitonesFromRoot === 0 ? 'font-bold text-orange-300' : ''}">${n.note}</span>`
            ).join(", ");
            document.getElementById("scale-notes-display").innerHTML = `Notas Diatónicas: ${detailedNotesHtml}`;
            document.getElementById("current-theory-text").textContent = `Aquí se muestran los 7 acordes diatónicos estándar (mayores, menores y disminuidos) de la tonalidad de ${actualRootMajorNote} Mayor.`;

            console.log("Circle notes highlighted with tonic, relative minor, and diatonic notes.");

            // Actualiza currentHighlightedKey para modos/diapasón (siempre necesita la clave mayor)
            currentHighlightedKey = actualRootMajorNote;

            // Llama a la función para actualizar la tabla de acordes diatónicos
            updateDiatonicChordsTable(actualRootMajorNote);
        }

        // Función para actualizar la sección de modos y el diapasón
        function updateModeDisplayAndFretboard() {
            console.log("updateModeDisplayAndFretboard called.");
            const modeDetailsDisplay = document.getElementById("mode-details-display");
            const selectedModeTitle = document.getElementById("selected-mode-title");
            const modeFormulaDisplay = document.getElementById("mode-formula-display");
            const modeNotesList = document.getElementById("mode-notes-list"); // Updated to list

            if (!currentHighlightedKey) {
                // Si no hay una tonalidad seleccionada en el círculo, limpia la sección de modos
                selectedModeTitle.textContent = "Modo: --";
                modeFormulaDisplay.textContent = "Fórmula: --";
                modeNotesList.innerHTML = '<li>Notas de la escala: --</li>'; // Reset list
                drawFretboard(); // Dibuja el diapasón vacío
                return;
            }

            const modeData = modesIntervals[currentSelectedMode];
            if (!modeData) {
                console.error("Modo no encontrado para la actualización:", currentSelectedMode);
                return;
            }

            // Determina la nota raíz para el diapasón. Si el modo es Eólico (menor), usa la relativa menor.
            let fretboardRootNote = currentHighlightedKey;
            if (currentSelectedMode === "Eólico (Menor)") {
                fretboardRootNote = relativeMinors[currentHighlightedKey];
            }

            // Obtiene las notas de la escala para el modo seleccionado y la tónica actual
            const modeNotesWithIntervals = getModeNotesWithIntervals(fretboardRootNote.replace('m', ''), currentSelectedMode); // Pass base note for getModeNotesWithIntervals

            // Actualiza la información en la sección de modos
            selectedModeTitle.textContent = `Modo: ${currentSelectedMode} de ${fretboardRootNote}`;
            modeFormulaDisplay.textContent = `Fórmula: ${modeData.formula}`;

            // Formatea las notas de la escala como una lista
            modeNotesList.innerHTML = '<li>Notas de la escala:</li>'; // Start with a header list item
            modeNotesWithIntervals.forEach(n => {
                const listItem = document.createElement('li');
                listItem.classList.add('ml-4'); // Indent list items
                listItem.innerHTML = `<span class="${n.semitonesFromRoot === 0 ? 'font-bold text-orange-300' : ''}">${n.note} (${n.interval})</span>`;
                modeNotesList.appendChild(listItem);
            });

            // Dibuja el diapasón con las notas del modo
            drawFretboard(modeNotesWithIntervals, fretboardRootNote);
            console.log("Mode display and fretboard updated.");
        }

        // Función para generar y actualizar la tabla de acordes diatónicos
        function updateDiatonicChordsTable(rootMajorNote) {
            console.log("updateDiatonicChordsTable called with:", rootMajorNote);
            const chordsRow = document.getElementById("diatonic-chords-row");
            chordsRow.innerHTML = ''; // Limpia las filas anteriores

            document.getElementById("diatonic-chords-key-display").textContent = `${rootMajorNote} Mayor`;

            // Grados y sus tipos de acorde en una escala mayor
            const chordDegrees = staticMusicalData.armonias.armonias_diatonicas.mayor;
            const diatonicChords = getDiatonicChordsForMajorKey(rootMajorNote);

            chordDegrees.forEach((romanNumeral) => {
                const chordName = diatonicChords[romanNumeral];
                const cell = document.createElement("td");
                cell.classList.add("chord-name");
                cell.textContent = chordName;
                chordsRow.appendChild(cell);
            });
            console.log("Diatonic chords table updated.");
        }


        // Función para reiniciar la selección a su estado inicial
        function resetSelection() {
            console.log("resetSelection called.");
            // Limpia los resaltados del círculo de quintas
            document.querySelectorAll(".note-group").forEach(group => {
                group.classList.remove("highlighted-tonic-major");
                group.classList.remove("highlighted-other-major-diatonic");
                group.classList.remove("highlighted-other-minor-diatonic");
                group.classList.remove("highlighted-diminished-diatonic");
            });

            // Reinicia la información mostrada del círculo
            document.getElementById("selected-key-title").textContent = "Selecciona una tonalidad...";
            document.getElementById("scale-notes-display").textContent = "Las notas diatónicas aparecerán aquí.";
            document.getElementById("current-theory-text").textContent = "Aquí aparecerá una explicación breve sobre la tonalidad mayor o menor que selecciones en el círculo.";

            // Reinicia el selector de modos
            document.getElementById("mode-select").value = "Jónico (Mayor)";
            currentSelectedMode = "Jónico (Mayor)";
            currentHighlightedKey = null; // Borra la clave seleccionada

            // Reinicia el selector de posición del diapasón
            document.getElementById("fretboard-position-select").value = "Full Fretboard";
            currentFretboardPosition = "Full Fretboard";

            // Limpia la sección de modos y el diapasón
            updateModeDisplayAndFretboard(); // Esto limpiará el diapasón y los detalles del modo

            // Limpia la tabla de acordes diatónicos
            document.getElementById("diatonic-chords-key-display").textContent = "--";
            document.getElementById("diatonic-chords-row").innerHTML = "<td>--</td><td>--</td><td>--</td><td>--</td><td>--</td><td>--</td><td>--</td>";

            // Limpia la sección de composición
            document.getElementById("song-idea-output").classList.add("hidden");
            document.getElementById("song-idea-title").textContent = "";
            document.getElementById("song-structure-table-body").innerHTML = "";
            document.getElementById("melody-tablature-svg").innerHTML = ""; // Now targets tablature SVG
            document.getElementById("solo-intention-text").textContent = "";
            document.getElementById("solo-proposal-text").textContent = "";
            document.getElementById("chord-diagrams-container").innerHTML = ""; // Limpia diagramas
            document.getElementById("strum-pattern-container").innerHTML = ""; // Limpia patrón de rasgueo

            // Reinicia los selectores de composición
            document.getElementById("feeling-select").value = "feliz";
            document.getElementById("style-select").value = "rock";
            document.getElementById("complexity-select").value = "facil";
            document.getElementById("num-modes-select").value = "1"; // Reinicia el número de modos
            currentSongIdea = null; // Clear the global song idea
            console.log("Selection reset.");
        }

        // Song structures based on complexity
        const songStructures = {
            "facil": [
                { sections: ["Intro", "Verso 1", "Estribillo", "Verso 2", "Estribillo", "Outro"], measures: { "Intro": 4, "Verso": 8, "Estribillo": 8, "Outro": 4 } },
                { sections: ["Verso 1", "Estribillo", "Verso 2", "Estribillo", "Puente", "Estribillo", "Outro"], measures: { "Verso": 8, "Estribillo": 8, "Puente": 4, "Outro": 4 } }
            ],
            "intermedio": [
                { sections: ["Intro", "Verso 1", "Pre-Estribillo", "Estribillo", "Verso 2", "Pre-Estribillo", "Estribillo", "Puente", "Solo", "Estribillo", "Outro"], measures: { "Intro": 4, "Verso": 8, "Pre-Estribillo": 4, "Estribillo": 8, "Puente": 8, "Solo": 8, "Outro": 4 } },
                { sections: ["Verso 1", "Estribillo", "Verso 2", "Estribillo", "Solo", "Puente", "Estribillo", "Outro"], measures: { "Verso": 8, "Estribillo": 8, "Solo": 8, "Puente": 8, "Outro": 4 } }
            ],
            "avanzado": [
                { sections: ["Intro 1", "Verso 1", "Pre-Estribillo", "Estribillo", "Intro 2", "Verso 2", "Puente", "Solo", "Estribillo", "Outro"], measures: { "Intro 1": 8, "Verso": 8, "Pre-Estribillo": 4, "Estribillo": 8, "Intro 2": 4, "Puente": 8, "Solo": 16, "Outro": 8 } },
                { sections: ["Intro", "Verso 1", "Estribillo", "Puente", "Verso 2", "Estribillo", "Solo", "Puente 2", "Outro"], measures: { "Intro": 8, "Verso": 8, "Estribillo": 8, "Puente": 8, "Solo": 16, "Puente 2": 8, "Outro": 8 } }
            ]
        };

        // Función para generar una idea de rola usando los datos estáticos
        async function generateCompositionRecommendation() {
            console.log("generateCompositionRecommendation called.");
            document.getElementById("loading-spinner").classList.remove("hidden");
            document.getElementById("song-idea-output").classList.add("hidden"); // Oculta el output anterior

            const feeling = document.getElementById("feeling-select").value;
            const style = document.getElementById("style-select").value.toLowerCase(); // Ensure lowercase for matching
            const complexity = document.getElementById("complexity-select").value;
            const numModes = parseInt(document.getElementById("num-modes-select").value);

            // Determine the root key for generation
            const rootKey = currentHighlightedKey || staticMusicalData.escalas.mayores[Math.floor(Math.random() * staticMusicalData.escalas.mayores.length)];
            const selectedMode = currentSelectedMode; // Use the currently selected mode from the dropdown

            let diatonicChordsMajor = getDiatonicChordsForMajorKey(rootKey);
            let diatonicChordsMinor = getDiatonicChordsForMinorKey(relativeMinors[rootKey].replace('m', '')); // Get minor diatonic chords

            // Select a song structure based on complexity
            const selectedStructureTemplate = songStructures[complexity][Math.floor(Math.random() * songStructures[complexity].length)];
            const structure = [];

            // Helper to get a random chord from a list of possibilities
            function getRandomChord(chordOptions) {
                return chordOptions[Math.floor(Math.random() * chordOptions.length)];
            }

            // Define chord progressions based on complexity
            const chordProgressions = {
                "facil": [
                    [diatonicChordsMajor.I, diatonicChordsMajor.IV, diatonicChordsMajor.V, diatonicChordsMajor.I],
                    [diatonicChordsMajor.I, diatonicChordsMajor.vi, diatonicChordsMajor.IV, diatonicChordsMajor.V]
                ],
                "intermedio": [
                    [diatonicChordsMajor.ii + "m", diatonicChordsMajor.V + "7", diatonicChordsMajor.I, diatonicChordsMajor.IV],
                    [diatonicChordsMajor.I, diatonicChordsMajor.vi + "m", diatonicChordsMajor.ii + "m", diatonicChordsMajor.V + "7"],
                    [diatonicChordsMajor.I, diatonicChordsMajor.IV + "sus4", diatonicChordsMajor.IV, diatonicChordsMajor.V]
                ],
                "avanzado": [
                    [diatonicChordsMajor.ii + "m7", diatonicChordsMajor.V + "7", diatonicChordsMajor.I + "maj7", diatonicChordsMajor.IV + "maj7"],
                    [diatonicChordsMinor.i + "m7", diatonicChordsMinor.VI + "", diatonicChordsMinor.VII + "", diatonicChordsMinor.i + "m7"], // Natural minor progression
                    [diatonicChordsMajor.I + "add9", diatonicChordsMajor.IV + "maj7", diatonicChordsMajor.vii + "°", diatonicChordsMajor.iii + "m7"],
                    [diatonicChordsMajor.vi + "m7", diatonicChordsMajor.ii + "m7b5", diatonicChordsMajor.V + "7", diatonicChordsMajor.I + "maj7"] // Jazz ii-V-I from vi
                ]
            };

            // Select a progression pattern based on complexity
            const selectedProgressionPattern = chordProgressions[complexity][Math.floor(Math.random() * chordProgressions[complexity].length)];

            // Generate melody notes based on the selected mode
            const modeNotes = getModeNotesWithIntervals(rootKey.replace('m', ''), selectedMode).map(n => n.note);
            const generateMelody = (length) => {
                const melody = [];
                for (let i = 0; i < length; i++) {
                    const randomNote = modeNotes[Math.floor(Math.random() * modeNotes.length)];
                    // Add a random octave for variety (e.g., C3, C4, C5)
                    const octave = Math.floor(Math.random() * 3) + 3; // Octaves 3, 4, 5
                    melody.push(randomNote + octave);
                }
                return melody;
            };

            // Build the song structure
            selectedStructureTemplate.sections.forEach(sectionName => {
                let sectionMeasures = selectedStructureTemplate.measures[sectionName.replace(/\s?\d+/, '')] || 4; // Get measures, remove numbers like "Intro 1" -> "Intro"
                let sectionChords = [];

                // Assign chords based on the selected progression pattern, repeating as needed
                for (let i = 0; i < sectionMeasures / 2; i++) { // Assuming 2 chords per 4 measures, adjust as needed
                    sectionChords.push(selectedProgressionPattern[i % selectedProgressionPattern.length]);
                }
                // Ensure unique chords for diagram generation later
                sectionChords = [...new Set(sectionChords)];


                structure.push({
                    section: sectionName,
                    measures: `${sectionMeasures} compases`,
                    chords: sectionChords,
                    melody_notes: generateMelody(sectionMeasures * 2) // 2 notes per measure for simplicity
                });
            });


            // Construct song idea
            currentSongIdea = { // Store in global variable
                "title": `Una rola ${feeling} de ${style} en ${rootKey} ${selectedMode}`,
                "structure": structure,
                "strumPatternComplexity": complexity, // Store complexity for strumming pattern
                "soloMelodyNotes": generateMelody(16), // A bit longer solo
                "soloIntention": `Un solo melódico que explore las notas del modo ${selectedMode} de ${rootKey}, con un toque ${feeling}.`,
                "suggestedModes": [selectedMode] // Start with the selected mode
            };

            // Add additional modes to solo intention if requested
            if (numModes > 1) {
                const availableModes = staticMusicalData.modos.filter(m => m !== selectedMode);
                for (let i = 0; i < numModes - 1 && i < availableModes.length; i++) {
                    currentSongIdea.soloIntention += ` También incorporando el modo ${availableModes[i]}.`;
                    currentSongIdea.suggestedModes.push(availableModes[i]);
                }
            }


            document.getElementById("loading-spinner").classList.add("hidden");
            displaySongIdea(currentSongIdea);
            console.log("Song idea generated and displayed successfully using static data.");
        }

        // Función para mostrar la idea de rola generada
        function displaySongIdea(songIdea) {
            console.log("displaySongIdea called with:", songIdea);
            document.getElementById("song-idea-output").classList.remove("hidden");
            document.getElementById("song-idea-title").textContent = songIdea.title;

            const structureTableBody = document.getElementById("song-structure-table-body");
            structureTableBody.innerHTML = "";
            let allMelodyNotes = []; // Para la tablature
            let allUniqueChords = new Set(); // Usar un Set para evitar acordes duplicados

            songIdea.structure.forEach(section => {
                const row = structureTableBody.insertRow();
                const sectionName = section.section || "N/A";
                const measures = section.measures || "N/A";
                const chords = section.chords ? section.chords.join(", ") : "N/A";
                const melodyNotes = section.melody_notes || [];

                row.innerHTML = `
                    <td class="p-2 border border-gray-600">${sectionName}</td>
                    <td class="p-2 border border-gray-600">${measures}</td>
                    <td class="p-2 border border-gray-600">${chords}</td>
                `;
                // Collect all unique chords for diagram generation
                if (section.chords) {
                    section.chords.forEach(chord => allUniqueChords.add(chord));
                }
                allMelodyNotes = allMelodyNotes.concat(melodyNotes);
            });

            document.getElementById("solo-intention-text").textContent = songIdea.soloIntention;
            document.getElementById("solo-proposal-text").textContent = songIdea.soloMelodyNotes.join(', ');

            // Dibuja los diagramas de acordes
            const chordDiagramsContainer = document.getElementById("chord-diagrams-container");
            chordDiagramsContainer.innerHTML = ""; // Limpia los diagramas anteriores
            allUniqueChords.forEach(chordName => {
                const voicings = getChordDiagramData(chordName);
                if (voicings && voicings.length > 0) {
                    const defaultVoicing = voicings[0]; // Display the first voicing by default
                    const svgElement = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                    svgElement.setAttribute("width", "100");
                    svgElement.setAttribute("height", "120");
                    svgElement.setAttribute("viewBox", "0 0 100 120");
                    svgElement.setAttribute("class", "chord-diagram-svg");
                    svgElement.setAttribute("data-chord-name", chordName); // Store original chord name
                    svgElement.setAttribute("data-voicing-index", 0); // Store index of current voicing

                    // Draw the default voicing directly into this SVG element
                    drawChordDiagram(svgElement, chordName, defaultVoicing); // Pass the SVG element directly

                    // Add click listener to open modal
                    svgElement.addEventListener('click', () => openChordOptionsModal(chordName));
                    chordDiagramsContainer.appendChild(svgElement);

                } else {
                    // Fallback for chords without diagrams
                    const placeholder = document.createElement('div');
                    placeholder.textContent = chordName;
                    placeholder.classList.add('p-4', 'bg-gray-600', 'rounded-md', 'text-center');
                    chordDiagramsContainer.appendChild(placeholder);
                }
            });


            // Dibuja el patrón de rasgueo
            drawStrummingPattern("strum-pattern-container", songIdea.strumPatternComplexity);

            // Dibuja la tablatura con las notas del solo
            drawMelodyTablature(songIdea.soloMelodyNotes); // Pass solo melody notes
            console.log("Song idea displayed.");
        }

        // Function to open chord options modal
        function openChordOptionsModal(chordName) {
            const modal = document.getElementById('chord-options-modal');
            const title = document.getElementById('chord-options-title');
            const container = document.getElementById('chord-options-container');

            title.textContent = `Opciones de Acorde: ${chordName}`;
            container.innerHTML = ''; // Clear previous options

            const voicings = getChordDiagramData(chordName);
            if (voicings && voicings.length > 0) {
                voicings.forEach((voicing, index) => {
                    // Create a container for each diagram and its name
                    const voicingWrapper = document.createElement('div');
                    voicingWrapper.classList.add('flex', 'flex-col', 'items-center', 'p-2', 'rounded-md', 'bg-gray-700');

                    const svgElement = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                    svgElement.setAttribute("width", "120");
                    svgElement.setAttribute("height", "140");
                    svgElement.setAttribute("viewBox", "0 0 120 140");
                    svgElement.setAttribute("class", "chord-diagram-svg"); // Re-use class
                    svgElement.setAttribute("data-chord-name", chordName);
                    svgElement.setAttribute("data-voicing-index", index);

                    drawChordDiagram(svgElement, chordName, voicing, true); // Pass true for modal styling

                    voicingWrapper.appendChild(svgElement);
                    container.appendChild(voicingWrapper);
                });
            } else {
                container.textContent = "No hay opciones de digitación disponibles para este acorde.";
            }

            modal.classList.remove('hidden');
        }

        // Function to close chord options modal
        function closeChordOptionsModal() {
            document.getElementById('chord-options-modal').classList.add('hidden');
        }


        // Función para exportar a MIDI (simplificado)
        function exportToMidi() {
            console.log("exportToMidi called.");
            if (!currentSongIdea) {
                alert("Primero genera una idea de rola para poder exportar a MIDI.");
                return;
            }

            // Basic MIDI constants
            const ticksPerBeat = 480; // Standard for MIDI files
            const tempoBPM = 120; // Default tempo
            const msPerBeat = 60000 / tempoBPM;
            const ticksPerMs = ticksPerBeat / msPerBeat;

            // MIDI Header Chunk (MThd)
            const header = [
                0x4d, 0x54, 0x68, 0x64, // MThd
                0x00, 0x00, 0x00, 0x06, // Length (6 bytes)
                0x00, 0x01,             // Format 1 (multiple tracks, synchronous)
                0x00, 0x01,             // Number of tracks (1 for simplicity)
                (ticksPerBeat >> 8) & 0xFF, ticksPerBeat & 0xFF // Division (ticks per quarter note)
            ];

            // MIDI Track Chunk (MTrk)
            let trackEvents = [];

            // Add tempo event (optional, but good practice)
            // Delta time, Set Tempo (FF 51 03), 3 bytes for microseconds per quarter note
            const microsecondsPerQuarterNote = 60000000 / tempoBPM;
            trackEvents.push(0x00, 0xFF, 0x51, 0x03,
                (microsecondsPerQuarterNote >> 16) & 0xFF,
                (microsecondsPerQuarterNote >> 8) & 0xFF,
                microsecondsPerQuarterNote & 0xFF
            );

            // Add Program Change (instrument) - Acoustic Grand Piano (0)
            trackEvents.push(0x00, 0xC0, 0x00); // Delta time 0, Program Change on Channel 0, Instrument 0

            // Process notes from the solo proposal for MIDI
            const soloNotes = currentSongIdea.soloMelodyNotes;

            const noteDurationTicks = ticksPerBeat / 2; // Each note is an eighth note for simplicity

            soloNotes.forEach(noteName => {
                // Try to parse octave from noteName (e.g., "C4")
                const match = noteName.match(/([A-G][b#]?)(\d+)?/);
                let baseNote = noteName;
                let octave = 4; // Default octave
                if (match && match[2]) {
                    baseNote = match[1];
                    octave = parseInt(match[2]);
                }

                const midiNote = getMidiNoteNumber(baseNote, octave);
                if (midiNote !== -1) {
                    // Note On event
                    trackEvents.push(0x00, 0x90, midiNote, 0x64); // Delta time 0, Note On, Note, Velocity (100)
                    // Note Off event
                    trackEvents.push(noteDurationTicks & 0xFF, 0x80, midiNote, 0x40); // Delta time (duration), Note Off, Note, Velocity (64)
                }
            });


            // End of Track event
            trackEvents.push(0x00, 0xFF, 0x2F, 0x00); // Delta time 0, End of Track

            const trackLength = trackEvents.length;
            const trackHeader = [
                0x4d, 0x54, 0x72, 0x6b, // MTrk
                (trackLength >> 24) & 0xFF, (trackLength >> 16) & 0xFF, (trackLength >> 8) & 0xFF, trackLength & 0xFF // Length of track chunk
            ];

            const midiData = new Uint8Array([...header, ...trackHeader, ...trackEvents]);

            // Create a Blob and a download link
            const blob = new Blob([midiData], { type: 'audio/midi' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentSongIdea.title.replace(/[^a-zA-Z0-9]/g, '_') || 'idea_de_rola'}.mid`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url); // Clean up
            console.log("MIDI exported.");
        }

        // --- Tuner Logic ---
        let audioContextTuner;
        let analyserTuner;
        let mediaStreamSourceTuner;
        let animationFrameIdTuner;
        let currentA4Frequency = 440; // Variable para la frecuencia de A4

        // Tuner related constants and functions
        const NOTES_IN_OCTAVE = 12;

        // Array of note names (sharps for simplicity in tuner)
        const noteNames = staticMusicalData.notas;

        // Calculate frequency for a given MIDI note number
        function midiToFrequency(midi) {
            return currentA4Frequency * Math.pow(2, (midi - 69) / NOTES_IN_OCTAVE);
        }

        // Calculate MIDI note number for a given frequency
        function frequencyToMidi(frequency) {
            return NOTES_IN_OCTAVE * (Math.log(frequency / currentA4Frequency) / Math.log(2)) + 69;
        }

        // Get note name and cents deviation from MIDI note number
        function getNoteAndCents(midi) {
            const noteIndex = Math.round(midi);
            const cents = Math.floor(100 * (midi - noteIndex));
            const noteName = noteNames[noteIndex % NOTES_IN_OCTAVE];
            return { noteName, cents };
        }

        // Target frequencies for common guitar tunings (MIDI notes for open strings)
        const tunings = {
            "Standard (EADGBe)": [40, 45, 50, 55, 59, 64], // E2, A2, D3, G3, B3, E4
            "Half Step Down (Eb Standard)": [39, 44, 49, 54, 58, 63], // Eb2, Ab2, Db3, Gb3, Bb3, Eb4
            "Full Step Down (D Standard)": [38, 43, 48, 53, 57, 62], // D2, G2, C3, F3, A3, D4
            "Drop D (DADGBe)": [38, 45, 50, 55, 59, 64], // D2, A2, D3, G3, B3, E4
            "Drop C# (C#G#C#F#A#D#)": [37, 42, 47, 52, 56, 61], // C#2, G#2, C#3, F#3, A#3, D#4
            "Drop C (CGCFAD)": [36, 43, 48, 53, 57, 62], // C2, G2, C3, F3, A3, D4
            "Open G (DGDGBD)": [38, 43, 50, 55, 59, 62], // D2, G2, D3, G3, B3, D4
            "Open D (DADF#AD)": [38, 45, 50, 54, 57, 62], // D2, A2, D3, F#3, A3, D4
            "Open E (EBEG#BE)": [40, 47, 52, 56, 59, 64], // E2, B2, E3, G#3, B3, E4
            // Add more as needed
        };

        // Populate tuner tuning dropdown
        function populateTunerTunings() {
            const tunerTuningSelect = document.getElementById("tuner-tuning-select");
            // Clear existing options
            tunerTuningSelect.innerHTML = '';
            for (const tuningName in tunings) {
                const option = document.createElement("option");
                option.value = tuningName;
                option.textContent = tuningName;
                tunerTuningSelect.appendChild(option);
            }
        }

        // Update open string notes based on selected string count and tuning
        function updateOpenStringNotesForTuner() {
            const selectedTuningName = document.getElementById("tuner-tuning-select").value;
            const selectedStringCount = parseInt(document.getElementById("tuner-strings-select").value);

            let baseTuning = tunings[selectedTuningName];
            if (!baseTuning) {
                console.warn("Afinación no encontrada, usando estándar.");
                baseTuning = tunings["Standard (EADGBe)"];
            }

            // Adjust baseTuning if string count is different.
            // This is a simplification; ideally, each string count would have its own tuning presets.
            // For now, if 7 or 8 strings are selected, we'll prepend lower notes.
            let currentOpenStringMidiNotes = [...baseTuning];

            if (selectedStringCount === 7 && baseTuning.length === 6) {
                currentOpenStringMidiNotes.unshift(baseTuning[0] - 5); // Add a B1 (5 semitones below E2)
            } else if (selectedStringCount === 8 && baseTuning.length === 6) {
                currentOpenStringMidiNotes.unshift(baseTuning[0] - 5); // Add B1
                currentOpenStringMidiNotes.unshift(baseTuning[0] - 5 - 7); // Add F#1 (7 semitones below B1)
            } else if (selectedStringCount === 8 && baseTuning.length === 7) {
                currentOpenStringMidiNotes.unshift(baseTuning[0] - 7); // Add F#1
            }

            // Trim or extend to the exact number of strings
            currentOpenStringMidiNotes = currentOpenStringMidiNotes.slice(currentOpenStringMidiNotes.length - selectedStringCount);

            // Update the global openStringNotes for fretboard/tablature if needed, but for tuner, we only need the MIDI values.
            // For the tuner, we'll just use these MIDI notes directly.
            return currentOpenStringMidiNotes;
        }


        async function startTuner() {
            console.log("startTuner called.");
            try {
                audioContextTuner = new (window.AudioContext || window.webkitAudioContext)();
                analyserTuner = audioContextTuner.createAnalyser();
                analyserTuner.fftSize = 2048; // Fast Fourier Transform size
                const bufferLength = analyserTuner.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);

                // Resume audio context if it's suspended (common for user gesture policy)
                if (audioContextTuner.state === 'suspended') {
                    await audioContextTuner.resume();
                    console.log("AudioContext resumed.");
                }

                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaStreamSourceTuner = audioContextTuner.createMediaStreamSource(stream);
                mediaStreamSourceTuner.connect(analyserTuner);
                console.log("Microphone access granted and audio context started.");

                const tunerNoteDisplay = document.getElementById("tuner-note");
                const tunerCentsDisplay = document.getElementById("tuner-cents");
                const tunerNeedle = document.querySelector(".tuner-needle");

                // Call updateOpenStringNotesForTuner to get the current target notes
                const targetOpenStringMidiNotes = updateOpenStringNotesForTuner();
                console.log("Tuner target notes:", targetOpenStringMidiNotes);

                function updateTuner() {
                    analyserTuner.getByteFrequencyData(dataArray);

                    let maxVolume = 0;
                    let maxIndex = -1;
                    for (let i = 0; i < bufferLength; i++) {
                        if (dataArray[i] > maxVolume) {
                            maxVolume = dataArray[i];
                            maxIndex = i;
                        }
                    }

                    if (maxVolume > 50) { // Simple volume threshold to filter out silence
                        const dominantFrequency = maxIndex * audioContextTuner.sampleRate / analyserTuner.fftSize;
                        const midi = frequencyToMidi(dominantFrequency);
                        const { noteName, cents } = getNoteAndCents(midi);

                        tunerNoteDisplay.textContent = noteName;
                        tunerCentsDisplay.textContent = `${cents} Cents`;

                        // Rotate needle based on cents (-50 to +50 range)
                        // Map cents from -50 to 50 to degrees -90 to 90
                        const rotation = (cents / 50) * 90;
                        tunerNeedle.style.transform = `rotate(${rotation}deg)`;

                    } else {
                        tunerNoteDisplay.textContent = "--";
                        tunerCentsDisplay.textContent = "-- Cents";
                        tunerNeedle.style.transform = `rotate(0deg)`; // Reset needle
                    }

                    animationFrameIdTuner = requestAnimationFrame(updateTuner);
                }
                updateTuner();

            } catch (err) {
                console.error("Error al acceder al micrófono:", err);
                alert("¡Uy! No pude acceder a tu micrófono. Asegúrate de darle permiso.");
            }
        }

        function stopTuner() {
            console.log("stopTuner called.");
            if (animationFrameIdTuner) {
                cancelAnimationFrame(animationFrameIdTuner);
                animationFrameIdTuner = null;
            }
            if (mediaStreamSourceTuner) {
                mediaStreamSourceTuner.disconnect();
                mediaStreamSourceTuner.mediaStream.getTracks().forEach(track => track.stop());
                mediaStreamSourceTuner = null;
                console.log("Media stream stopped.");
            }
            if (audioContextTuner && audioContextTuner.state !== 'closed') {
                audioContextTuner.close();
                audioContextTuner = null;
                console.log("Audio context closed.");
            }
            document.getElementById("tuner-note").textContent = "--";
            document.getElementById("tuner-cents").textContent = "-- Cents";
            document.querySelector(".tuner-needle").style.transform = `rotate(0deg)`;
        }

        // --- Metronome Logic ---
        let audioContextMetronome;
        let isMetronomeRunning = false;
        let nextBeatTime = 0;
        let currentBeat = 0;
        let beatsPerMeasure = 4;
        let bpm = 120;
        let lookahead = 25.0; // How far ahead to schedule audio (ms)
        let scheduleAheadTime = 0.1; // How far ahead to schedule audio (sec)
        let intervalIdMetronome;

        const beatIndicatorsContainer = document.getElementById("beat-indicators");

        function setupMetronomeAudio() {
            if (!audioContextMetronome) {
                audioContextMetronome = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function createClick(time, isStrongBeat) {
            if (!audioContextMetronome) return;

            const oscillator = audioContextMetronome.createOscillator();
            const gainNode = audioContextMetronome.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContextMetronome.destination);

            oscillator.type = 'sine'; // Simple sine wave for click
            oscillator.frequency.setValueAtTime(isStrongBeat ? 880 : 660, audioContextMetronome.currentTime); // Higher freq for strong beat, distinct for others
            gainNode.gain.setValueAtTime(0.7, audioContextMetronome.currentTime); // Ensure audible gain for all clicks
            gainNode.gain.exponentialRampToValueAtTime(0.001, time + 0.05); // Quick decay

            oscillator.start(time);
            oscillator.stop(time + 0.05);
        }

        function scheduleBeat() {
            while (nextBeatTime < audioContextMetronome.currentTime + scheduleAheadTime) {
                currentBeat = (currentBeat % beatsPerMeasure) + 1;
                const isStrongBeat = (currentBeat === 1);
                createClick(nextBeatTime, isStrongBeat);
                updateBeatIndicators(currentBeat);

                const secondsPerBeat = 60 / bpm;
                nextBeatTime += secondsPerBeat;
            }
        }

        function startMetronome() {
            if (isMetronomeRunning) return;
            setupMetronomeAudio();
            isMetronomeRunning = true;
            currentBeat = 0; // Reset beat counter
            nextBeatTime = audioContextMetronome.currentTime + 0.05; // Schedule first beat slightly in future
            intervalIdMetronome = setInterval(scheduleBeat, lookahead);
            console.log("Metronome started.");
        }

        function stopMetronome() {
            if (!isMetronomeRunning) return;
            isMetronomeRunning = false;
            clearInterval(intervalIdMetronome);
            // Do not close audioContextMetronome here, as it might be shared or needed later by tuner
            resetBeatIndicators();
            console.log("Metronome stopped.");
        }

        function updateMetronomeDisplay() {
            document.getElementById("metronome-bpm-display").textContent = `${bpm} BPM`;
        }

        function updateBeatIndicators(activeBeat = 0) {
            beatIndicatorsContainer.innerHTML = ''; // Clear existing indicators
            for (let i = 1; i <= beatsPerMeasure; i++) {
                const indicator = document.createElement("div");
                indicator.classList.add("metronome-beat-indicator");
                if (i === activeBeat) {
                    indicator.classList.add("active");
                }
                if (i === 1) { // First beat
                    indicator.classList.add("first-beat");
                }
                beatIndicatorsContainer.appendChild(indicator);
            }
        }

        function resetBeatIndicators() {
            document.querySelectorAll(".metronome-beat-indicator").forEach(indicator => {
                indicator.classList.remove("active");
                indicator.classList.remove("first-beat"); // Ensure first-beat styling is also reset
            });
            updateBeatIndicators(0); // Redraw with no active beat
        }


        // --- Event Listeners ---
        document.addEventListener("DOMContentLoaded", () => {
            console.log("DOM Content Loaded. Initializing app.");
            try {
                populateModeDropdown(); // Primero llena el desplegable de modos
                console.log("Mode dropdown populated.");
                drawCircleOfFifths(); // Luego dibuja el círculo
                console.log("Circle of Fifths drawn.");
                // drawFretboard(); // No dibujar el diapasón aquí, se hará en updateModeDisplayAndFretboard
                updateModeDisplayAndFretboard(); // Llama esto para inicializar el diapasón y los detalles del modo
                console.log("Fretboard initialized via updateModeDisplayAndFretboard.");

                // Inicializa la tabla de acordes diatónicos con un estado por defecto
                updateDiatonicChordsTable(currentHighlightedKey || "C"); // Muestra C mayor por defecto o la última seleccionada
                console.log("Diatonic chords table initialized.");

                // Agrega el listener para el botón de Reiniciar
                document.getElementById("reset-button").addEventListener("click", resetSelection);
                console.log("Reset button listener added.");
                // Agrega el listener para el botón de Generar Idea de Rola
                document.getElementById("generate-song-idea-button").addEventListener("click", generateCompositionRecommendation);
                console.log("Generate song idea button listener added.");
                // Agrega el listener para el botón de Imprimir
                document.getElementById("print-button").addEventListener("click", () => {
                    if (!currentSongIdea) {
                        alert("Primero genera una idea de rola para poder imprimir.");
                        return;
                    }

                    const printWindow = window.open('', '', 'height=800,width=800');
                    printWindow.document.write('<html><head><title>Imprimir Idea de Rola</title>');
                    // Copy relevant styles for printing
                    printWindow.document.write('<style>');
                    printWindow.document.write(`
                        body { font-family: 'Inter', sans-serif; color: #1a202c; margin: 20px; }
                        h1, h2, h3, h4 { color: #f6ad55; margin-bottom: 10px; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
                        .tablature-container { font-family: 'monospace'; white-space: pre; background-color: #f0f0f0; padding: 10px; border-radius: 5px; }
                        .chord-diagrams-container { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
                        .chord-diagram-svg { border: 1px solid #a0aec0; border-radius: 4px; background-color: #fff; margin-right: 10px; margin-bottom: 10px; }
                        .fret-line, .string-line { stroke: #333; }
                        .nut-line { stroke: #333; stroke-width: 3; }
                        .finger-dot { fill: #f6ad55; stroke: #ed8936; }
                        .open-string-marker { stroke: #333; }
                        .muted-string-marker { fill: #333; font-size: 16px; font-weight: bold; }
                        .strum-pattern-svg { background-color: #f0f0f0; padding: 10px; border-radius: 4px; }
                        .strum-arrow { fill: #333; }
                        .strum-beat-text { fill: #666; }
                        .strum-rest-symbol { fill: #333; }
                    `);
                    printWindow.document.write('</style></head><body>');

                    // Get content from the main page
                    const songIdeaTitle = document.getElementById("song-idea-title").textContent;
                    const songStructureTableBodyHTML = document.getElementById("song-structure-table-body").innerHTML;
                    const soloIntention = document.getElementById("solo-intention-text").textContent;
                    const soloProposal = document.getElementById("solo-proposal-text").textContent;

                    // Re-create chord diagrams SVG in the print window
                    const tempChordDiagramsContainer = document.createElement('div');
                    tempChordDiagramsContainer.classList.add('chord-diagrams-container');
                    const uniqueChordsInSong = [...new Set(currentSongIdea.structure.flatMap(s => s.chords))];
                    uniqueChordsInSong.forEach(chordName => {
                        const voicings = getChordDiagramData(chordName);
                        if (voicings && voicings.length > 0) {
                            drawChordDiagram(tempChordDiagramsContainer, chordName, voicings[0]); // Draw default voicing
                        }
                    });
                    const chordDiagramsContent = tempChordDiagramsContainer.innerHTML;

                    // Re-create strum pattern SVG in the print window
                    const tempStrumPatternContainer = document.createElement('div');
                    tempStrumPatternContainer.classList.add('strum-pattern-container');
                    drawStrummingPattern(tempStrumPatternContainer.id, currentSongIdea.strumPatternComplexity);
                    const strumPatternContent = tempStrumPatternContainer.innerHTML;


                    // Re-create the tablature SVG as a string (since it's dynamic)
                    const tempTabSvg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                    tempTabSvg.setAttribute("width", "800"); // Fixed width for printing
                    tempTabSvg.setAttribute("height", "150"); // Height for tablature only
                    tempTabSvg.setAttribute("viewBox", "0 0 800 150");
                    const tablatureString = generateTablatureString(currentSongIdea.soloMelodyNotes); // Reuse existing function
                    const tabLines = tablatureString.split('\n');
                    const tabStartY = 20; // Start Y for tablature
                    const tabLineSpacing = 15;
                    tabLines.forEach((line, index) => {
                        const y = tabStartY + (index * tabLineSpacing);
                        const tabText = document.createElementNS("http://www.w3.org/2000/svg", "text");
                        tabText.setAttribute("x", 20);
                        tabText.setAttribute("y", y);
                        tabText.setAttribute("fill", "#1a202c"); // Dark text for print
                        tabText.setAttribute("font-family", "monospace");
                        tabText.setAttribute("font-size", "14px");
                        tabText.textContent = line;
                        tempTabSvg.appendChild(tabText);
                    });
                    const tablatureSvgString = new XMLSerializer().serializeToString(tempTabSvg);


                    printWindow.document.write(`
                        <h1>${songIdeaTitle}</h1>
                        <h2>Estructura del Tema:</h2>
                        <table><thead><tr><th>Sección</th><th>Compases</th><th>Acordes</th></tr></thead><tbody>${songStructureTableBodyHTML}</tbody></table>
                        <h2>Diagramas de Acordes:</h2>
                        <div class="chord-diagrams-container">${chordDiagramsContent}</div>
                        <h2>Patrón de Rasgueo Sugerido:</h2>
                        <div class="strum-pattern-container">${strumPatternContent}</div>
                        <h2>Melodía (Tablatura):</h2>
                        <div class="tablature-container">${tablatureSvgString}</div>
                        <h2>Intención del Solo:</h2>
                        <p>${soloIntention}</p>
                        <h2>Propuesta de Solo (Notas):</h2>
                        <p>${soloProposal}</p>
                    `);
                    printWindow.document.write('</body></html>');
                    printWindow.document.close();
                    printWindow.focus();
                    printWindow.print();
                });
                console.log("Print button listener added.");
                // Agrega el listener para el botón de Exportar a MIDI
                document.getElementById("export-midi-button").addEventListener("click", exportToMidi);
                console.log("Export MIDI button listener added.");

                // Tuner button and modal
                const tunerModal = document.getElementById("tuner-modal");
                document.getElementById("open-tuner-button").addEventListener("click", () => {
                    tunerModal.classList.remove("hidden");
                    populateTunerTunings(); // Populate tunings when modal opens
                    // Start tuner when modal opens, but only if A4 frequency is set
                    const a4Slider = document.getElementById("a4-frequency-slider");
                    document.getElementById("a4-frequency-display").textContent = `${a4Slider.value} Hz`;
                    currentA4Frequency = parseFloat(a4Slider.value);
                    startTuner();
                });
                document.getElementById("close-tuner-button").addEventListener("click", () => {
                    tunerModal.classList.add("hidden");
                    stopTuner(); // Stop tuner when modal closes
                });
                document.getElementById("start-tuner-button").addEventListener("click", startTuner);
                document.getElementById("stop-tuner-button").addEventListener("click", stopTuner);
                console.log("Tuner start/stop button listeners added.");

                // Update tuner target notes when tuning or string count changes
                document.getElementById("tuner-tuning-select").addEventListener("change", updateOpenStringNotesForTuner);
                document.getElementById("tuner-strings-select").addEventListener("change", updateOpenStringNotesForTuner);
                
                // A4 frequency slider listener
                const a4FrequencySlider = document.getElementById("a4-frequency-slider");
                const a4FrequencyDisplay = document.getElementById("a4-frequency-display");
                a4FrequencySlider.addEventListener("input", (event) => {
                    currentA4Frequency = parseFloat(event.target.value);
                    a4FrequencyDisplay.textContent = `${currentA4Frequency} Hz`;
                    // If tuner is running, restart it to apply new A4 frequency
                    if (audioContextTuner && mediaStreamSourceTuner) { // Check if tuner is active
                        stopTuner(); // Stop it first
                        startTuner(); // Then restart it
                    }
                });
                console.log("Tuner dropdown and A4 slider listeners added.");

                // Metronome button and modal
                const metronomeModal = document.getElementById("metronome-modal");
                document.getElementById("open-metronome-button").addEventListener("click", () => {
                    metronomeModal.classList.remove("hidden");
                    updateMetronomeDisplay(); // Set initial display
                    updateBeatIndicators(0); // Draw initial beat indicators
                });
                document.getElementById("close-metronome-button").addEventListener("click", () => {
                    metronomeModal.classList.add("hidden");
                    stopMetronome(); // Stop metronome when modal closes
                });
                document.getElementById("start-metronome-button").addEventListener("click", startMetronome);
                document.getElementById("stop-metronome-button").addEventListener("click", stopMetronome);

                document.getElementById("bpm-slider").addEventListener("input", (event) => {
                    bpm = parseInt(event.target.value);
                    updateMetronomeDisplay();
                    if (isMetronomeRunning) {
                        stopMetronome();
                        startMetronome();
                    }
                });
                document.getElementById("beats-per-measure-select").addEventListener("change", (event) => {
                    beatsPerMeasure = parseInt(event.target.value);
                    updateBeatIndicators(0); // Redraw indicators for new beat count
                    if (isMetronomeRunning) {
                        stopMetronome();
                        startMetronome();
                    }
                });

                console.log("Metronome button and listeners added.");

                // Fretboard Position Select Listener
                document.getElementById("fretboard-position-select").addEventListener("change", (event) => {
                    currentFretboardPosition = event.target.value;
                    updateModeDisplayAndFretboard();
                });

                // Chord Options Modal listeners
                document.getElementById('close-chord-options-button').addEventListener('click', closeChordOptionsModal);

            } catch (e) {
                console.error("Error during DOMContentLoaded initialization:", e);
                alert("¡Uy! Hubo un error al iniciar la aplicación. Revisa la consola para más detalles.");
            }
        });
        
    </script>
</body>
</html>
